<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Combining PhotoGEA With Other Packages • PhotoGEA</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Combining PhotoGEA With Other Packages">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    padding-top: 70px;

    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">PhotoGEA</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.2.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/PhotoGEA.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/analyzing_ball_berry_data.html">Analyzing Ball-Berry Data</a></li>
    <li><a class="dropdown-item" href="../articles/analyzing_c3_aci_curves.html">Analyzing C3 A-Ci Curves</a></li>
    <li><a class="dropdown-item" href="../articles/analyzing_c4_aci_curves.html">Analyzing C4 A-Ci Curves</a></li>
    <li><a class="dropdown-item" href="../articles/analyzing_gm_data.html">Analyzing Mesophyll Conductance Data</a></li>
    <li><a class="dropdown-item" href="../articles/analyzing_tdl_data.html">Analyzing TDL Data</a></li>
    <li><a class="dropdown-item" href="../articles/combining_with_other_packages.html">Combining PhotoGEA With Other Packages</a></li>
    <li><a class="dropdown-item" href="../articles/creating_your_own_processing_tools.html">Creating Your Own Processing Tools</a></li>
    <li><a class="dropdown-item" href="../articles/developing_a_data_analysis_pipeline.html">Developing a Data Analysis Pipeline</a></li>
    <li><a class="dropdown-item" href="../articles/LI6800_user_constants.html">Guide to Licor LI-6800 User Constants</a></li>
    <li><a class="dropdown-item" href="../articles/working_with_extended_data_frames.html">Working With Extended Data Frames</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/eloch216/PhotoGEA/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.svg" class="logo" alt=""><h1>Combining PhotoGEA With Other Packages</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/eloch216/PhotoGEA/blob/v1.2.0/vignettes/combining_with_other_packages.Rmd" class="external-link"><code>vignettes/combining_with_other_packages.Rmd</code></a></small>
      <div class="d-none name"><code>combining_with_other_packages.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h2>
<p>There are many approaches to fitting or otherwise processing pieces
of gas exchange data, and several R packages (such as <a href="https://cran.r-project.org/package=plantecophys" class="external-link"><code>plantecophys</code></a>,
<a href="https://cran.r-project.org/package=plantecowrap" class="external-link"><code>plantecowrap</code></a>,
and <a href="https://cran.r-project.org/package=photosynthesis" class="external-link"><code>photosynthesis</code></a>)
have been written to implement some of these methods. These R packages
are excellent resources that provide access to well-tested and
peer-reviewed fitting methods. On the other hand, they generally do not
provide tools for a full data analysis pipeline. Instead, these packages
assume that the user has already solved the problems of data translation
and validation; in other words, they assume that the user already has an
appropriately validated data set available as one or R data
structures.</p>
<p>To address this issue, it is possible to use functions from these
other packages within the context of <code>PhotoGEA</code>. In this
case, <code>PhotoGEA</code> can be used to load data, validate it, apply
the functions to subsets of the data, and collect the results, as
described in the <a href="developing_a_data_analysis_pipeline.html">Developing a Data
Analysis Pipeline</a> vignette.</p>
<p>The key to combining another package with <code>PhotoGEA</code> is to
create “wrappers” for the other package’s functions. A wrapper is a type
of function whose main purpose is to call another function while making
minimal calculations of its own. Wrappers can be created for many
different purposes, as discussed on <a href="https://en.wikipedia.org/wiki/Wrapper_function" class="external-link">Wikipedia</a>. In
this context, wrappers will be used to reformat the inputs and outputs
of a function from another package so they become compatible with
functions from <code>PhotoGEA</code>.</p>
<p>As an example, this vignette will demonstrate how to create two
wrappers of varying complexity for the <code>fitaci</code> function from
the <code>plantecophys</code> package. The general ideas introduced here
can also be used to create wrappers for other functions, although the
details of creating a wrapper are heavily dependent on the details of
the function to be wrapped. Note that creating a wrapper for a fitting
function from another package is essentially a special case of designing
a customized processing function, a topic that is also covered in the <a href="creating_your_own_processing_tools.html">Creating Your Own
Processing Tools</a> vignette.</p>
</div>
<div class="section level2">
<h2 id="loading-packages">Loading Packages<a class="anchor" aria-label="anchor" href="#loading-packages"></a>
</h2>
<p>As always, the first step is to load the packages we will be using.
In addition to <code>PhotoGEA</code>, we will also use the
<code>plantecophys</code> and <code>lattice</code> packages.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load required packages</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/eloch216/PhotoGEA" class="external-link">PhotoGEA</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://bitbucket.org/remkoduursma/plantecophys" class="external-link">plantecophys</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://lattice.r-forge.r-project.org/" class="external-link">lattice</a></span><span class="op">)</span></span></code></pre></div>
<p>If the <code>plantecophys</code> or <code>lattice</code> packages are
not installed on your R setup, you can install them by typing
<code>install.packages('plantecophys')</code> and/or
<code>install.packages('lattice')</code>.</p>
</div>
<div class="section level2">
<h2 id="loading-and-validating-data">Loading and Validating Data<a class="anchor" aria-label="anchor" href="#loading-and-validating-data"></a>
</h2>
<p>For this example, we will load the same set of C<sub>3</sub> A-Ci
curves that are used in the <a href="analyzing_c3_aci_curves.html">Analyzing C3 A-Ci Curves</a>
vignette, and we will perform the same steps for organizing and cleaning
the data. See that vignette for more details about these steps. For
brevity, the commands are not included here, but they can be found at
the end of this vignette in <a href="#commands-from-this-document">Commands From This Document</a>.</p>
</div>
<div class="section level2">
<h2 id="creating-a-minimal-wrapper">Creating a Minimal Wrapper<a class="anchor" aria-label="anchor" href="#creating-a-minimal-wrapper"></a>
</h2>
<p>The <code>fitaci</code> function from the <code>plantecophys</code>
package is a tool for fitting a single C<sub>3</sub> CO<sub>2</sub>
response curve, so it can be thought of as an alternative to the
<code>fit_c3_aci</code> function from <code>PhotoGEA</code>. In the <a href="analyzing_c3_aci_curves.html">Analyzing C3 A-Ci Curves</a>
vignette, the following command is used to apply <code>fit_c3_aci</code>
to all the response curves in the data set and then consolidate the
results from each curve into a convenient list of tables:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">c3_aci_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/consolidate.html">consolidate</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/by.html" class="external-link">by</a></span><span class="op">(</span></span>
<span>  <span class="va">licor_data</span>,                       <span class="co"># The `exdf` object containing the curves</span></span>
<span>  <span class="va">licor_data</span><span class="op">[</span>, <span class="st">'curve_identifier'</span><span class="op">]</span>, <span class="co"># A factor used to split `licor_data` into chunks</span></span>
<span>  <span class="va">fit_c3_aci</span>,                       <span class="co"># The function to apply to each chunk of `licor_data`</span></span>
<span>  fixed <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="cn">NA</span>, <span class="cn">NA</span>, <span class="cn">NA</span><span class="op">)</span>,        <span class="co"># Additional argument passed to `fit_c3_aci`</span></span>
<span>  cj_crossover_min <span class="op">=</span> <span class="fl">100</span>,           <span class="co"># Wj must be &gt; Wc when Cc &lt; 100 ppm</span></span>
<span>  cj_crossover_max <span class="op">=</span> <span class="fl">550</span>            <span class="co"># Wj must be &lt; Wc when Cc &gt; 550 ppm</span></span>
<span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Ideally, we would like to be able to use a similar command to apply
<code><a href="https://rdrr.io/pkg/plantecophys/man/fitaci.html" class="external-link">plantecophys::fitaci</a></code> to all the curves. However,
<code><a href="https://rdrr.io/pkg/plantecophys/man/fitaci.html" class="external-link">plantecophys::fitaci</a></code> has a different type of input data
table (it uses a data frame while <code>fit_c3_aci</code> uses an
<code>exdf</code>) and produces a different type of output (it returns
an <code>acifit</code> object while <code>fit_c3_aci</code> returns a
list of <code>exdf</code> objects). (There are also a few other
differences that will be discussed later.) In this situation, as
discussed previously, we can use a wrapper function to make
<code><a href="https://rdrr.io/pkg/plantecophys/man/fitaci.html" class="external-link">plantecophys::fitaci</a></code> behave more like
<code><a href="../reference/fit_c3_aci.html">PhotoGEA::fit_c3_aci</a></code> so it can be used in the same way.</p>
<p>Here is one way to create such a wrapper:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Make a minimal wrapper for `plantecophys::fitaci`</span></span>
<span><span class="va">fit_c3_aci_plantecophys</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span></span>
<span>  <span class="va">replicate_exdf</span>, <span class="co"># an `exdf` object representing a single A-Ci curve</span></span>
<span>  <span class="va">...</span>             <span class="co"># additional named arguments to be passed to `fitaci`</span></span>
<span><span class="op">)</span></span>
<span><span class="op">{</span></span>
<span>  <span class="co"># Call `plantecophys::fitaci` by passing the `replicate_exdf$main_data`</span></span>
<span>  <span class="co"># data frame as the `data` input argument</span></span>
<span>  <span class="va">fit_res</span> <span class="op">&lt;-</span> <span class="fu">plantecophys</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/plantecophys/man/fitaci.html" class="external-link">fitaci</a></span><span class="op">(</span><span class="va">replicate_exdf</span><span class="op">$</span><span class="va">main_data</span>, <span class="va">...</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Get the identifier columns from the original exdf object as a data frame</span></span>
<span>  <span class="va">replicate_identifiers</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/identifier_columns.html">identifier_columns</a></span><span class="op">(</span><span class="va">replicate_exdf</span><span class="op">$</span><span class="va">main_data</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Get a data frame with the fitted values of assimilation and append the</span></span>
<span>  <span class="co"># identifier columns</span></span>
<span>  <span class="va">fits</span> <span class="op">&lt;-</span> <span class="va">fit_res</span><span class="op">$</span><span class="va">df</span></span>
<span>  <span class="va">fits</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">replicate_identifiers</span>, <span class="va">fits</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># `plantecophys::fitaci` returns absurdly high values of `Ap` when it cannot</span></span>
<span>  <span class="co"># get a good estimate for `Tp`. These can cause problems when plotting the</span></span>
<span>  <span class="co"># results, so we replace any `Ap` values above 500 micromol / m^2 / s with</span></span>
<span>  <span class="co"># NA.</span></span>
<span>  <span class="va">fits</span><span class="op">[</span><span class="va">fits</span><span class="op">$</span><span class="va">Ap</span> <span class="op">&gt;</span> <span class="fl">500</span>, <span class="st">'Ap'</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span></span>
<span>  <span class="co"># Create a data frame with the parameter values</span></span>
<span>  <span class="va">parameters</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    Vcmax          <span class="op">=</span> <span class="va">fit_res</span><span class="op">$</span><span class="va">par</span><span class="op">[</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">]</span>,</span>
<span>    Jmax           <span class="op">=</span> <span class="va">fit_res</span><span class="op">$</span><span class="va">par</span><span class="op">[</span><span class="fl">2</span>, <span class="fl">1</span><span class="op">]</span>,</span>
<span>    Rd             <span class="op">=</span> <span class="va">fit_res</span><span class="op">$</span><span class="va">par</span><span class="op">[</span><span class="fl">3</span>, <span class="fl">1</span><span class="op">]</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="va">parameters</span><span class="op">$</span><span class="va">Tp</span> <span class="op">&lt;-</span> <span class="kw">if</span> <span class="op">(</span><span class="va">fit_res</span><span class="op">$</span><span class="va">fitTPU</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">fit_res</span><span class="op">$</span><span class="va">par</span><span class="op">[</span><span class="fl">4</span>, <span class="fl">1</span><span class="op">]</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="cn">NA</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="va">parameters</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">replicate_identifiers</span>, <span class="va">parameters</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Return a list of two data frames: `fits` and `parameters`</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    fits <span class="op">=</span> <span class="va">fits</span>,</span>
<span>    parameters <span class="op">=</span> <span class="va">parameters</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Much of the code in <code>fit_c3_aci_plantecophys</code> is devoted
to converting the <code>replicate_exdf</code> input from an
<code>exdf</code> object to a <code>data.frame</code> and returning a
list of <code>data.frame</code> objects that were created from the
return value of <code>fitaci</code>. One subtelty in the code is the use
of the <code>identifier_columns</code> function.</p>
<p>By default, the output from <code>fitaci</code> includes important
information like the modeled assimilation rates and the values of the
key C<sub>3</sub> parameters. However, it does not include any of the
“identifying” information that is essential for keeping the results
organized. (In this case, this would be the values of the
<code>species</code> and <code>plot</code> columns.) The
<code>identifier_columns</code> function from <code>PhotoGEA</code>
provides a simple way to retrieve this information from the
<code>replicate_exdf</code> input. To accomplish this, it determines the
columns that only have a single value and returns the singular values of
those columns.</p>
<p>Using <code>identifier_columns</code> rather than directly accessing
the values of <code>species</code> or <code>plot</code> makes the
<code>fit_c3_aci_plantecophys</code> function more flexible. In fact,
all fitting functions in the <code>PhotoGEA</code> package make use of
<code>identifier_columns</code> to keep track of these important pieces
of “metadata.”</p>
<p>Another important point is that we have “regularized” the fitting
results by always including <code>Tp</code>, even when it is not being
fitted. In general, it is easier to work with functions that always
produce the same output quantities.</p>
<p>Now we can apply this function to all the curves in the data set.
Note that we will need to specify a value for the <code>varnames</code>
input argument of <code><a href="https://rdrr.io/pkg/plantecophys/man/fitaci.html" class="external-link">plantecophys::fitaci</a></code> because our columns
have different names than the default ones. This can be accomplished
with the following command, which makes use of <code>by.exdf</code> and
<code>consolidate</code> as in the <a href="analyzing_c3_aci_curves.html">Analyzing C3 A-Ci Curves</a>
vignette:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Fit each curve</span></span>
<span><span class="va">c3_aci_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/consolidate.html">consolidate</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/by.html" class="external-link">by</a></span><span class="op">(</span></span>
<span>  <span class="va">licor_data</span>,                       <span class="co"># The `exdf` object containing the curves</span></span>
<span>  <span class="va">licor_data</span><span class="op">[</span>, <span class="st">'curve_identifier'</span><span class="op">]</span>, <span class="co"># A factor used to split `licor_data` into chunks</span></span>
<span>  <span class="va">fit_c3_aci_plantecophys</span>,          <span class="co"># The function to apply to each chunk of `licor_data`</span></span>
<span>  varnames <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>                  <span class="co"># Additional argument to `fit_c3_aci_plantecophys`</span></span>
<span>    ALEAF <span class="op">=</span> <span class="st">'A'</span>,</span>
<span>    Tleaf <span class="op">=</span> <span class="st">'TleafCnd'</span>,</span>
<span>    Ci <span class="op">=</span> <span class="st">'Ci'</span>,</span>
<span>    PPFD <span class="op">=</span> <span class="st">'Qin'</span>,</span>
<span>    Rd <span class="op">=</span> <span class="st">'Rd'</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The results can now be examined using commands similar to the ones
used in the <a href="analyzing_c3_aci_curves.html">Analyzing C3 A-Ci
Curves</a> vignette:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Plot each fit</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/lattice/man/xyplot.html" class="external-link">xyplot</a></span><span class="op">(</span></span>
<span>  <span class="va">Ameas</span> <span class="op">+</span> <span class="op">(</span><span class="va">Ac</span> <span class="op">-</span> <span class="va">Rd</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="va">Aj</span> <span class="op">-</span> <span class="va">Rd</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="va">Ap</span> <span class="op">-</span> <span class="va">Rd</span><span class="op">)</span> <span class="op">+</span> <span class="va">Amodel</span> <span class="op">~</span> <span class="va">Ci_original</span> <span class="op">|</span> <span class="va">curve_identifier</span>,</span>
<span>  data <span class="op">=</span> <span class="va">c3_aci_results</span><span class="op">$</span><span class="va">fits</span>,</span>
<span>  type <span class="op">=</span> <span class="st">'l'</span>,</span>
<span>  auto.key <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>space <span class="op">=</span> <span class="st">'right'</span><span class="op">)</span>,</span>
<span>  grid <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  xlab <span class="op">=</span> <span class="st">'Intercellular CO2 concentration (ppm)'</span>,</span>
<span>  ylab <span class="op">=</span> <span class="st">'Assimilation rate (micromol / m^2 / s)'</span>,</span>
<span>  par.settings <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    superpose.line <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>col <span class="op">=</span> <span class="fu"><a href="../reference/multi_curve_colors.html">multi_curve_colors</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    superpose.symbol <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>col <span class="op">=</span> <span class="fu"><a href="../reference/multi_curve_colors.html">multi_curve_colors</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="combining_with_other_packages_files/figure-html/unnamed-chunk-5-1.png" width="720" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># View the parameter values</span></span>
<span><span class="va">columns_for_viewing</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'instrument'</span>, <span class="st">'species'</span>, <span class="st">'plot'</span>, <span class="st">'Vcmax'</span>, <span class="st">'Jmax'</span>, <span class="st">'Rd'</span>, <span class="st">'Tp'</span><span class="op">)</span></span>
<span></span>
<span><span class="va">c3_aci_parameters</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">c3_aci_results</span><span class="op">$</span><span class="va">parameters</span><span class="op">[</span> , <span class="va">columns_for_viewing</span><span class="op">]</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">c3_aci_parameters</span><span class="op">)</span></span>
<span><span class="co">#&gt;   instrument species plot     Vcmax     Jmax        Rd Tp</span></span>
<span><span class="co">#&gt; 1      ripe1 soybean   5a 126.61884 229.5225 0.8502736 NA</span></span>
<span><span class="co">#&gt; 2      ripe1 tobacco    1 128.90039 272.3661 0.5237317 NA</span></span>
<span><span class="co">#&gt; 3      ripe1 tobacco    2 109.78883 244.9742 0.6525278 NA</span></span>
<span><span class="co">#&gt; 4      ripe2 soybean    1  99.85103 158.7873 0.3908915 NA</span></span>
<span><span class="co">#&gt; 5      ripe2 soybean   5b 115.84216 189.9087 1.6311796 NA</span></span>
<span><span class="co">#&gt; 6      ripe2 tobacco    4  83.51227 178.1061 0.3925865 NA</span></span></code></pre></div>
<p>There are a few things to notice about these commands and the
resulting outputs:</p>
<ul>
<li>In the plotting command above, we subtract <code>Rd</code> from
<code>Ac</code>, <code>Aj</code>, and <code>Ap</code> because
<code><a href="https://rdrr.io/pkg/plantecophys/man/fitaci.html" class="external-link">plantecophys::fitaci</a></code> uses different definitions of these
rates that are equivalent to <code>Ac + Rd</code>, <code>Aj + Rd</code>,
and <code>Ap + Rd</code> in our notation.</li>
<li>In the results, <code>Tp</code> and <code>Ap</code> are both
<code>NA</code> because the <code>fitTPU</code> argument of
<code><a href="https://rdrr.io/pkg/plantecophys/man/fitaci.html" class="external-link">plantecophys::fitaci</a></code> was left at its default value of
<code>FALSE</code>. When we attempt to include <code>Ap</code> in the
plot, <code><a href="https://rdrr.io/pkg/lattice/man/xyplot.html" class="external-link">lattice::xyplot</a></code> simply does not plot anything because
the values are <code>NA</code>.</li>
</ul>
</div>
<div class="section level2">
<h2 id="creating-a-fancier-wrapper">Creating a Fancier Wrapper<a class="anchor" aria-label="anchor" href="#creating-a-fancier-wrapper"></a>
</h2>
<p>The wrapper above is quite useful because it allows us to easily
apply <code>fitaci</code> to many response curves in a full data set and
automatically combine the results using the <code>by</code> and
<code>consolidate</code> functions. However, it could be improved by
making a few changes that:</p>
<ul>
<li>Provide better default values for the column names.</li>
<li>Check the units of important columns.</li>
<li>Include more outputs that are calculated by
<code>fitaci</code>.</li>
<li>Return a list of <code>exdf</code> objects rather than a list of
data frames.</li>
<li>Return only net assimilation rates.</li>
</ul>
<p>Here is an example of a more complex wrapper that is a bit more
user-friendly than the previous one. In this wrapper, we explicitly
break the code into several sections devoted to checking inputs, calling
<code>fitaci</code> with appropriate units, and collecting outputs:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Make a better wrapper for `plantecophys::fitaci`</span></span>
<span><span class="va">fit_c3_aci_plantecophys</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span></span>
<span>  <span class="va">replicate_exdf</span>, <span class="co"># an `exdf` object representing a single A-Ci curve</span></span>
<span>  <span class="va">a_column_name</span> <span class="op">=</span> <span class="st">'A'</span>,</span>
<span>  <span class="va">tleaf_column_name</span> <span class="op">=</span> <span class="st">'TleafCnd'</span>,</span>
<span>  <span class="va">ci_column_name</span> <span class="op">=</span> <span class="st">'Ci'</span>,</span>
<span>  <span class="va">qin_column_name</span> <span class="op">=</span> <span class="st">'Qin'</span>,</span>
<span>  <span class="va">rd_column_name</span> <span class="op">=</span> <span class="st">'Rd'</span>,</span>
<span>  <span class="va">useRd</span> <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  <span class="va">...</span> <span class="co"># additional named arguments to be passed to `fitaci`</span></span>
<span><span class="op">)</span></span>
<span><span class="op">{</span></span>
<span>  <span class="co">### Check inputs</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="../reference/is.exdf.html">is.exdf</a></span><span class="op">(</span><span class="va">replicate_exdf</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">'fit_c3_aci_plantecophys requires an exdf object'</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># Make sure the required variables are defined and have the correct units</span></span>
<span>  <span class="va">required_variables</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">required_variables</span><span class="op">[[</span><span class="va">a_column_name</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">'micromol m^(-2) s^(-1)'</span></span>
<span>  <span class="va">required_variables</span><span class="op">[[</span><span class="va">tleaf_column_name</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"degrees C"</span></span>
<span>  <span class="va">required_variables</span><span class="op">[[</span><span class="va">ci_column_name</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">'micromol mol^(-1)'</span></span>
<span>  <span class="va">required_variables</span><span class="op">[[</span><span class="va">qin_column_name</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">'micromol m^(-2) s^(-1)'</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">useRd</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Only check the existence and units of the `Rd` column if it will be used</span></span>
<span>    <span class="va">required_variables</span><span class="op">[[</span><span class="va">rd_column_name</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">'micromol m^(-2) s^(-1)'</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="fu"><a href="../reference/check_required_variables.html">check_required_variables</a></span><span class="op">(</span><span class="va">replicate_exdf</span>, <span class="va">required_variables</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Make sure the user didn't supply their own `varnames` because we will</span></span>
<span>  <span class="co"># automatically define it from the other column name inputs</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="st">'varnames'</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">...</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">'do not supply `varnames` when calling fit_c3_aci_plantecophys'</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co">### Call function from external packge with appropriate units</span></span>
<span></span>
<span>  <span class="va">fit_res</span> <span class="op">&lt;-</span> <span class="fu">plantecophys</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/plantecophys/man/fitaci.html" class="external-link">fitaci</a></span><span class="op">(</span></span>
<span>    <span class="va">replicate_exdf</span><span class="op">$</span><span class="va">main_data</span>,</span>
<span>    varnames <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        ALEAF <span class="op">=</span> <span class="va">a_column_name</span>,</span>
<span>        Tleaf <span class="op">=</span> <span class="va">tleaf_column_name</span>,</span>
<span>        Ci <span class="op">=</span> <span class="va">ci_column_name</span>,</span>
<span>        PPFD <span class="op">=</span> <span class="va">qin_column_name</span>,</span>
<span>        Rd <span class="op">=</span> <span class="va">rd_column_name</span></span>
<span>    <span class="op">)</span>,</span>
<span>    useRd <span class="op">=</span> <span class="va">useRd</span>,</span>
<span>    <span class="va">...</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co">### Collect outputs</span></span>
<span></span>
<span>  <span class="co"># Get the identifier columns from the original exdf object</span></span>
<span>  <span class="va">replicate_identifiers</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/identifier_columns.html">identifier_columns</a></span><span class="op">(</span><span class="va">replicate_exdf</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Get a data frame with the fitted values of assimilation and convert it to an</span></span>
<span>  <span class="co"># `exdf` object, setting the category to `fit_c3_aci_plantecophys` and</span></span>
<span>  <span class="co"># specifying the units for each column</span></span>
<span>  <span class="va">fits</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/exdf.html">exdf</a></span><span class="op">(</span><span class="va">fit_res</span><span class="op">$</span><span class="va">df</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">fits</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/document_variables.html">document_variables</a></span><span class="op">(</span></span>
<span>    <span class="va">fits</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'fit_c3_aci_plantecophys'</span>, <span class="st">'Ci'</span>,          <span class="st">'micromol mol^(-1)'</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'fit_c3_aci_plantecophys'</span>, <span class="st">'Ameas'</span>,       <span class="st">'micromol m^(-2) s^(-1)'</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'fit_c3_aci_plantecophys'</span>, <span class="st">'Amodel'</span>,      <span class="st">'micromol m^(-2) s^(-1)'</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'fit_c3_aci_plantecophys'</span>, <span class="st">'Ac'</span>,          <span class="st">'micromol m^(-2) s^(-1)'</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'fit_c3_aci_plantecophys'</span>, <span class="st">'Aj'</span>,          <span class="st">'micromol m^(-2) s^(-1)'</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'fit_c3_aci_plantecophys'</span>, <span class="st">'Ap'</span>,          <span class="st">'micromol m^(-2) s^(-1)'</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'fit_c3_aci_plantecophys'</span>, <span class="st">'Rd'</span>,          <span class="st">'micromol m^(-2) s^(-1)'</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'fit_c3_aci_plantecophys'</span>, <span class="st">'VPD'</span>,         <span class="st">'kPa'</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'fit_c3_aci_plantecophys'</span>, <span class="st">'Tleaf'</span>,       <span class="st">'degrees C'</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'fit_c3_aci_plantecophys'</span>, <span class="st">'Cc'</span>,          <span class="st">'micromol mol^(-1)'</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'fit_c3_aci_plantecophys'</span>, <span class="st">'PPFD'</span>,        <span class="st">'micromol m^(-2) s^(-1)'</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'fit_c3_aci_plantecophys'</span>, <span class="st">'Patm'</span>,        <span class="st">'kPa'</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'fit_c3_aci_plantecophys'</span>, <span class="st">'Ci_original'</span>, <span class="st">'micromol mol^(-1)'</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Append the identifier columns to the fits</span></span>
<span>  <span class="va">fits</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">replicate_identifiers</span>, <span class="va">fits</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># `plantecophys::fitaci` returns absurdly high values of `Ap` when it cannot</span></span>
<span>  <span class="co"># get a good estimate for `Tp`. These can cause problems when plotting the</span></span>
<span>  <span class="co"># results, so we replace any `Ap` values above 500 micromol / m^2 / s with</span></span>
<span>  <span class="co"># NA.</span></span>
<span>  <span class="va">fits</span><span class="op">[</span><span class="va">fits</span><span class="op">[</span>, <span class="st">'Ap'</span><span class="op">]</span> <span class="op">&gt;</span> <span class="fl">500</span>, <span class="st">'Ap'</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span></span>
<span>  <span class="co"># Convert `plantecophys::fitaci` outputs to net CO2 assimilation rates for</span></span>
<span>  <span class="co"># consistency with `fit_c3_aci`.</span></span>
<span>  <span class="va">fits</span><span class="op">[</span>, <span class="st">'Ac'</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">fits</span><span class="op">[</span>, <span class="st">'Ac'</span><span class="op">]</span> <span class="op">-</span> <span class="va">fits</span><span class="op">[</span>, <span class="st">'Rd'</span><span class="op">]</span></span>
<span>  <span class="va">fits</span><span class="op">[</span>, <span class="st">'Aj'</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">fits</span><span class="op">[</span>, <span class="st">'Aj'</span><span class="op">]</span> <span class="op">-</span> <span class="va">fits</span><span class="op">[</span>, <span class="st">'Rd'</span><span class="op">]</span></span>
<span>  <span class="va">fits</span><span class="op">[</span>, <span class="st">'Ap'</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">fits</span><span class="op">[</span>, <span class="st">'Ap'</span><span class="op">]</span> <span class="op">-</span> <span class="va">fits</span><span class="op">[</span>, <span class="st">'Rd'</span><span class="op">]</span></span>
<span></span>
<span>  <span class="co"># Add a column for the residuals</span></span>
<span>  <span class="va">fits</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/set_variable.html">set_variable</a></span><span class="op">(</span></span>
<span>    <span class="va">fits</span>,</span>
<span>    <span class="st">'A_residuals'</span>,</span>
<span>    <span class="st">'micromol m^(-2) s^(-1)'</span>,</span>
<span>    <span class="st">'fit_c3_aci_plantecophys'</span>,</span>
<span>    <span class="va">fits</span><span class="op">[</span>, <span class="st">'Ameas'</span><span class="op">]</span> <span class="op">-</span> <span class="va">fits</span><span class="op">[</span>, <span class="st">'Amodel'</span><span class="op">]</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Create an exdf object with the parameter values that are included in the</span></span>
<span>  <span class="co"># fitting result. Note that we do not include RMSE because it is not</span></span>
<span>  <span class="co"># calculated correctly.</span></span>
<span>  <span class="va">parameters</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/exdf.html">exdf</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    Ci_transition  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">fit_res</span><span class="op">$</span><span class="va">Ci_transition</span><span class="op">)</span>,</span>
<span>    Ci_transition2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">fit_res</span><span class="op">$</span><span class="va">Ci_transition2</span><span class="op">)</span>,</span>
<span>    Tcorrect       <span class="op">=</span> <span class="va">fit_res</span><span class="op">$</span><span class="va">Tcorrect</span>,</span>
<span>    Rd_measured    <span class="op">=</span> <span class="va">fit_res</span><span class="op">$</span><span class="va">Rd_measured</span>,</span>
<span>    GammaStar      <span class="op">=</span> <span class="va">fit_res</span><span class="op">$</span><span class="va">GammaStar</span>,</span>
<span>    Km             <span class="op">=</span> <span class="va">fit_res</span><span class="op">$</span><span class="va">Km</span>,</span>
<span>    kminput        <span class="op">=</span> <span class="va">fit_res</span><span class="op">$</span><span class="va">kminput</span>,</span>
<span>    gstarinput     <span class="op">=</span> <span class="va">fit_res</span><span class="op">$</span><span class="va">gstarinput</span>,</span>
<span>    fitmethod      <span class="op">=</span> <span class="va">fit_res</span><span class="op">$</span><span class="va">fitmethod</span>,</span>
<span>    citransition   <span class="op">=</span> <span class="va">fit_res</span><span class="op">$</span><span class="va">citransition</span>,</span>
<span>    gmeso          <span class="op">=</span> <span class="va">fit_res</span><span class="op">$</span><span class="va">gmeso</span>,</span>
<span>    fitTPU         <span class="op">=</span> <span class="va">fit_res</span><span class="op">$</span><span class="va">fitTPU</span>,</span>
<span>    alphag         <span class="op">=</span> <span class="va">fit_res</span><span class="op">$</span><span class="va">alphag</span>,</span>
<span>    Vcmax          <span class="op">=</span> <span class="va">fit_res</span><span class="op">$</span><span class="va">par</span><span class="op">[</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">]</span>,</span>
<span>    Vcmax_err      <span class="op">=</span> <span class="va">fit_res</span><span class="op">$</span><span class="va">par</span><span class="op">[</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">]</span>,</span>
<span>    Jmax           <span class="op">=</span> <span class="va">fit_res</span><span class="op">$</span><span class="va">par</span><span class="op">[</span><span class="fl">2</span>, <span class="fl">1</span><span class="op">]</span>,</span>
<span>    Jmax_err       <span class="op">=</span> <span class="va">fit_res</span><span class="op">$</span><span class="va">par</span><span class="op">[</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">]</span>,</span>
<span>    Rd             <span class="op">=</span> <span class="va">fit_res</span><span class="op">$</span><span class="va">par</span><span class="op">[</span><span class="fl">3</span>, <span class="fl">1</span><span class="op">]</span>,</span>
<span>    Rd_err         <span class="op">=</span> <span class="va">fit_res</span><span class="op">$</span><span class="va">par</span><span class="op">[</span><span class="fl">3</span>, <span class="fl">2</span><span class="op">]</span>,</span>
<span>    ci_star        <span class="op">=</span> <span class="va">fit_res</span><span class="op">$</span><span class="fu">Ci</span><span class="op">(</span><span class="fl">0</span><span class="op">)</span>,</span>
<span>    A_transition   <span class="op">=</span> <span class="va">fit_res</span><span class="op">$</span><span class="fu">Photosyn</span><span class="op">(</span>Ci<span class="op">=</span><span class="va">fit_res</span><span class="op">$</span><span class="va">Ci_transition</span><span class="op">)</span><span class="op">$</span><span class="va">ALEAF</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># The value of `Tp` and its error will depend on `fitTPU`</span></span>
<span>  <span class="va">parameters</span><span class="op">[</span>, <span class="st">'Tp'</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="kw">if</span> <span class="op">(</span><span class="va">fit_res</span><span class="op">$</span><span class="va">fitTPU</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">fit_res</span><span class="op">$</span><span class="va">par</span><span class="op">[</span><span class="fl">4</span>, <span class="fl">1</span><span class="op">]</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="cn">NA</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="va">parameters</span><span class="op">[</span>, <span class="st">'TPU_err'</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="kw">if</span> <span class="op">(</span><span class="va">fit_res</span><span class="op">$</span><span class="va">fitTPU</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">fit_res</span><span class="op">$</span><span class="va">par</span><span class="op">[</span><span class="fl">4</span>, <span class="fl">2</span><span class="op">]</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="cn">NA</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># Document the parameter units</span></span>
<span>  <span class="va">parameters</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/document_variables.html">document_variables</a></span><span class="op">(</span></span>
<span>    <span class="va">parameters</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'fit_c3_aci_plantecophys'</span>, <span class="st">'Ci_transition'</span>,  <span class="st">'micromol mol^(-1)'</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'fit_c3_aci_plantecophys'</span>, <span class="st">'Ci_transition2'</span>, <span class="st">'micromol mol^(-1)'</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'fit_c3_aci_plantecophys'</span>, <span class="st">'Tcorrect'</span>,       <span class="st">''</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'fit_c3_aci_plantecophys'</span>, <span class="st">'Rd_measured'</span>,    <span class="st">''</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'fit_c3_aci_plantecophys'</span>, <span class="st">'GammaStar'</span>,      <span class="st">'micromol mol^(-1)'</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'fit_c3_aci_plantecophys'</span>, <span class="st">'Km'</span>,             <span class="st">'micromol mol^(-1)'</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'fit_c3_aci_plantecophys'</span>, <span class="st">'kminput'</span>,        <span class="st">''</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'fit_c3_aci_plantecophys'</span>, <span class="st">'gstarinput'</span>,     <span class="st">''</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'fit_c3_aci_plantecophys'</span>, <span class="st">'fitmethod'</span>,      <span class="st">''</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'fit_c3_aci_plantecophys'</span>, <span class="st">'citransition'</span>,   <span class="st">'micromol mol^(-1)'</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'fit_c3_aci_plantecophys'</span>, <span class="st">'gmeso'</span>,          <span class="st">'mol m^(-2) s^(-1)'</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'fit_c3_aci_plantecophys'</span>, <span class="st">'fitTPU'</span>,         <span class="st">''</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'fit_c3_aci_plantecophys'</span>, <span class="st">'alphag'</span>,         <span class="st">'dimensionless'</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'fit_c3_aci_plantecophys'</span>, <span class="st">'Vcmax'</span>,          <span class="st">'micromol m^(-2) s^(-1)'</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'fit_c3_aci_plantecophys'</span>, <span class="st">'Vcmax_err'</span>,      <span class="st">'micromol m^(-2) s^(-1)'</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'fit_c3_aci_plantecophys'</span>, <span class="st">'Jmax'</span>,           <span class="st">'micromol m^(-2) s^(-1)'</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'fit_c3_aci_plantecophys'</span>, <span class="st">'Jmax_err'</span>,       <span class="st">'micromol m^(-2) s^(-1)'</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'fit_c3_aci_plantecophys'</span>, <span class="st">'Rd'</span>,             <span class="st">'micromol m^(-2) s^(-1)'</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'fit_c3_aci_plantecophys'</span>, <span class="st">'Rd_err'</span>,         <span class="st">'micromol m^(-2) s^(-1)'</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'fit_c3_aci_plantecophys'</span>, <span class="st">'Tp'</span>,             <span class="st">'micromol m^(-2) s^(-1)'</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'fit_c3_aci_plantecophys'</span>, <span class="st">'TPU_err'</span>,        <span class="st">'micromol m^(-2) s^(-1)'</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'fit_c3_aci_plantecophys'</span>, <span class="st">'ci_star'</span>,        <span class="st">'micromol mol^(-1)'</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'fit_c3_aci_plantecophys'</span>, <span class="st">'A_transition'</span>,   <span class="st">'micromol m^(-2) s^(-1)'</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Append the identifier columns to the parameters</span></span>
<span>  <span class="va">parameters</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">replicate_identifiers</span>, <span class="va">parameters</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Return a list of two data frames: `fits` and `parameters`</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      fits <span class="op">=</span> <span class="va">fits</span>,</span>
<span>      parameters <span class="op">=</span> <span class="va">parameters</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>The code for the wrapper has now gotten significantly longer, but
there are several new benefits to the user, such as the following:</p>
<ul>
<li>The units of the input columns are checked.</li>
<li>The wrapper returns <code>exdf</code> objects that include
units.</li>
<li>The assimilation rates have also all been standardized to net
rates.</li>
<li>The fit residuals are included with the output.</li>
</ul>
<p>If you are writing a wrapper that will be used often, it may be worth
taking the time to add nicer features like these ones.</p>
<p>With this wrapper, we can fit all the curves in a dataset and examine
the results using the following code, which is simpler than the previous
version:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Fit each curve</span></span>
<span><span class="va">c3_aci_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/consolidate.html">consolidate</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/by.html" class="external-link">by</a></span><span class="op">(</span></span>
<span>  <span class="va">licor_data</span>,                       <span class="co"># The `exdf` object containing the curves</span></span>
<span>  <span class="va">licor_data</span><span class="op">[</span>, <span class="st">'curve_identifier'</span><span class="op">]</span>, <span class="co"># A factor used to split `licor_data` into chunks</span></span>
<span>  <span class="va">fit_c3_aci_plantecophys</span>           <span class="co"># The function to apply to each chunk of `licor_data`</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot each fit</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/lattice/man/xyplot.html" class="external-link">xyplot</a></span><span class="op">(</span></span>
<span>  <span class="va">Ameas</span> <span class="op">+</span> <span class="va">Ac</span> <span class="op">+</span> <span class="va">Aj</span> <span class="op">+</span> <span class="va">Ap</span> <span class="op">+</span> <span class="va">Amodel</span> <span class="op">~</span> <span class="va">Ci_original</span> <span class="op">|</span> <span class="va">curve_identifier</span>,</span>
<span>  data <span class="op">=</span> <span class="va">c3_aci_results</span><span class="op">$</span><span class="va">fits</span><span class="op">$</span><span class="va">main_data</span>,</span>
<span>  type <span class="op">=</span> <span class="st">'l'</span>,</span>
<span>  auto.key <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>space <span class="op">=</span> <span class="st">'right'</span><span class="op">)</span>,</span>
<span>  grid <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  xlab <span class="op">=</span> <span class="st">'Intercellular CO2 concentration (ppm)'</span>,</span>
<span>  ylab <span class="op">=</span> <span class="st">'Assimilation rate (micromol / m^2 / s)'</span>,</span>
<span>  par.settings <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    superpose.line <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>col <span class="op">=</span> <span class="fu"><a href="../reference/multi_curve_colors.html">multi_curve_colors</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    superpose.symbol <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>col <span class="op">=</span> <span class="fu"><a href="../reference/multi_curve_colors.html">multi_curve_colors</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="combining_with_other_packages_files/figure-html/make_and_examine_fit-1.png" width="720" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># View the parameter values</span></span>
<span><span class="va">columns_for_viewing</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'instrument'</span>, <span class="st">'species'</span>, <span class="st">'plot'</span>, <span class="st">'Vcmax'</span>, <span class="st">'Jmax'</span>, <span class="st">'Rd'</span>, <span class="st">'Tp'</span><span class="op">)</span></span>
<span></span>
<span><span class="va">c3_aci_parameters</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">c3_aci_results</span><span class="op">$</span><span class="va">parameters</span><span class="op">[</span> , <span class="va">columns_for_viewing</span>, <span class="cn">TRUE</span><span class="op">]</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">c3_aci_parameters</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Converting an `exdf` object to a `data.frame` before printing</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;   instrument [UserDefCon] (NA) species [UserDefCon] (NA) plot [UserDefCon] (NA)</span></span>
<span><span class="co">#&gt; 1                        ripe1                   soybean                     5a</span></span>
<span><span class="co">#&gt; 2                        ripe1                   tobacco                      1</span></span>
<span><span class="co">#&gt; 3                        ripe1                   tobacco                      2</span></span>
<span><span class="co">#&gt; 4                        ripe2                   soybean                      1</span></span>
<span><span class="co">#&gt; 5                        ripe2                   soybean                     5b</span></span>
<span><span class="co">#&gt; 6                        ripe2                   tobacco                      4</span></span>
<span><span class="co">#&gt;   Vcmax [fit_c3_aci_plantecophys] (micromol m^(-2) s^(-1))</span></span>
<span><span class="co">#&gt; 1                                                126.61884</span></span>
<span><span class="co">#&gt; 2                                                128.90039</span></span>
<span><span class="co">#&gt; 3                                                109.78883</span></span>
<span><span class="co">#&gt; 4                                                 99.85103</span></span>
<span><span class="co">#&gt; 5                                                115.84216</span></span>
<span><span class="co">#&gt; 6                                                 83.51227</span></span>
<span><span class="co">#&gt;   Jmax [fit_c3_aci_plantecophys] (micromol m^(-2) s^(-1))</span></span>
<span><span class="co">#&gt; 1                                                229.5225</span></span>
<span><span class="co">#&gt; 2                                                272.3661</span></span>
<span><span class="co">#&gt; 3                                                244.9742</span></span>
<span><span class="co">#&gt; 4                                                158.7873</span></span>
<span><span class="co">#&gt; 5                                                189.9087</span></span>
<span><span class="co">#&gt; 6                                                178.1061</span></span>
<span><span class="co">#&gt;   Rd [fit_c3_aci_plantecophys] (micromol m^(-2) s^(-1))</span></span>
<span><span class="co">#&gt; 1                                             0.8502736</span></span>
<span><span class="co">#&gt; 2                                             0.5237317</span></span>
<span><span class="co">#&gt; 3                                             0.6525278</span></span>
<span><span class="co">#&gt; 4                                             0.3908915</span></span>
<span><span class="co">#&gt; 5                                             1.6311796</span></span>
<span><span class="co">#&gt; 6                                             0.3925865</span></span>
<span><span class="co">#&gt;   Tp [fit_c3_aci_plantecophys] (micromol m^(-2) s^(-1))</span></span>
<span><span class="co">#&gt; 1                                                    NA</span></span>
<span><span class="co">#&gt; 2                                                    NA</span></span>
<span><span class="co">#&gt; 3                                                    NA</span></span>
<span><span class="co">#&gt; 4                                                    NA</span></span>
<span><span class="co">#&gt; 5                                                    NA</span></span>
<span><span class="co">#&gt; 6                                                    NA</span></span></code></pre></div>
<p>It’s also easy to plot the residuals now:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Plot the residuals</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/lattice/man/xyplot.html" class="external-link">xyplot</a></span><span class="op">(</span></span>
<span>  <span class="va">A_residuals</span> <span class="op">~</span> <span class="va">Ci_original</span> <span class="op">|</span> <span class="va">curve_identifier</span>,</span>
<span>  data <span class="op">=</span> <span class="va">c3_aci_results</span><span class="op">$</span><span class="va">fits</span><span class="op">$</span><span class="va">main_data</span>,</span>
<span>  type <span class="op">=</span> <span class="st">'b'</span>,</span>
<span>  pch <span class="op">=</span> <span class="fl">16</span>,</span>
<span>  grid <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  xlab <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">'Intercellular CO2 concentration ('</span>,</span>
<span>    <span class="va">c3_aci_results</span><span class="op">$</span><span class="va">fits</span><span class="op">$</span><span class="va">units</span><span class="op">$</span><span class="va">Ci_original</span>, <span class="st">')'</span><span class="op">)</span>,</span>
<span>  ylab <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">'Assimilation rate residual (measured - fitted)\n('</span>,</span>
<span>    <span class="va">c3_aci_results</span><span class="op">$</span><span class="va">fits</span><span class="op">$</span><span class="va">units</span><span class="op">$</span><span class="va">A_residuals</span>, <span class="st">')'</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="combining_with_other_packages_files/figure-html/plot_residuals-1.png" width="720" style="display: block; margin: auto;"></p>
</div>
<div class="section level2">
<h2 id="commands-from-this-document">Commands From This Document<a class="anchor" aria-label="anchor" href="#commands-from-this-document"></a>
</h2>
<p>The following code chunk includes all the central commands used
throughout this document. They are compiled here to make them easy to
copy/paste into a text file to initialize your own script.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load required packages</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/eloch216/PhotoGEA" class="external-link">PhotoGEA</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://bitbucket.org/remkoduursma/plantecophys" class="external-link">plantecophys</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://lattice.r-forge.r-project.org/" class="external-link">lattice</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Define a vector of paths to the files we wish to load</span></span>
<span><span class="va">file_paths</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/PhotoGEA_example_file_path.html">PhotoGEA_example_file_path</a></span><span class="op">(</span><span class="st">'c3_aci_1.xlsx'</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/PhotoGEA_example_file_path.html">PhotoGEA_example_file_path</a></span><span class="op">(</span><span class="st">'c3_aci_2.xlsx'</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Load each file, storing the result in a list</span></span>
<span><span class="va">licor_exdf_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">file_paths</span>, <span class="kw">function</span><span class="op">(</span><span class="va">fpath</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/read_gasex_file.html">read_gasex_file</a></span><span class="op">(</span><span class="va">fpath</span>, <span class="st">'time'</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Get the names of all columns that are present in all of the Licor files</span></span>
<span><span class="va">columns_to_keep</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">identify_common_columns</span>, <span class="va">licor_exdf_list</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Extract just these columns</span></span>
<span><span class="va">licor_exdf_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">licor_exdf_list</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">x</span><span class="op">[</span> , <span class="va">columns_to_keep</span>, <span class="cn">TRUE</span><span class="op">]</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Use `rbind` to combine all the data</span></span>
<span><span class="va">licor_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="va">licor_exdf_list</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create a new identifier column formatted like `instrument - species - plot`</span></span>
<span><span class="va">licor_data</span><span class="op">[</span> , <span class="st">'curve_identifier'</span><span class="op">]</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">licor_data</span><span class="op">[</span> , <span class="st">'instrument'</span><span class="op">]</span>, <span class="st">'-'</span>, <span class="va">licor_data</span><span class="op">[</span> , <span class="st">'species'</span><span class="op">]</span>, <span class="st">'-'</span>, <span class="va">licor_data</span><span class="op">[</span> , <span class="st">'plot'</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Make sure the data meets basic requirements</span></span>
<span><span class="fu"><a href="../reference/check_response_curve_data.html">check_response_curve_data</a></span><span class="op">(</span><span class="va">licor_data</span>, <span class="st">'curve_identifier'</span>, <span class="fl">16</span>, <span class="st">'CO2_r_sp'</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Remove points with duplicated `CO2_r_sp` values and order by `Ci`</span></span>
<span><span class="va">licor_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/organize_response_curve_data.html">organize_response_curve_data</a></span><span class="op">(</span></span>
<span>    <span class="va">licor_data</span>,</span>
<span>    <span class="st">'curve_identifier'</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">9</span>, <span class="fl">10</span><span class="op">)</span>,</span>
<span>    <span class="st">'Ci'</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Only keep points where stability was achieved</span></span>
<span><span class="va">licor_data</span> <span class="op">&lt;-</span> <span class="va">licor_data</span><span class="op">[</span><span class="va">licor_data</span><span class="op">[</span>, <span class="st">'Stable'</span><span class="op">]</span> <span class="op">==</span> <span class="fl">2</span>, , <span class="cn">TRUE</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Remove any curves that have fewer than three remaining points</span></span>
<span><span class="va">npts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/by.html" class="external-link">by</a></span><span class="op">(</span><span class="va">licor_data</span>, <span class="va">licor_data</span><span class="op">[</span>, <span class="st">'curve_identifier'</span><span class="op">]</span>, <span class="va">nrow</span><span class="op">)</span></span>
<span><span class="va">ids_to_keep</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">npts</span><span class="op">[</span><span class="va">npts</span> <span class="op">&gt;</span> <span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">licor_data</span> <span class="op">&lt;-</span> <span class="va">licor_data</span><span class="op">[</span><span class="va">licor_data</span><span class="op">[</span>, <span class="st">'curve_identifier'</span><span class="op">]</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">ids_to_keep</span>, , <span class="cn">TRUE</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Remove points where `instrument` is `ripe1` and `CO2_r_sp` is 1800</span></span>
<span><span class="va">licor_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/remove_points.html">remove_points</a></span><span class="op">(</span></span>
<span>  <span class="va">licor_data</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>instrument <span class="op">=</span> <span class="st">'ripe1'</span>, CO2_r_sp <span class="op">=</span> <span class="fl">1800</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Make a better wrapper for `plantecophys::fitaci`</span></span>
<span><span class="va">fit_c3_aci_plantecophys</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span></span>
<span>  <span class="va">replicate_exdf</span>, <span class="co"># an `exdf` object representing a single A-Ci curve</span></span>
<span>  <span class="va">a_column_name</span> <span class="op">=</span> <span class="st">'A'</span>,</span>
<span>  <span class="va">tleaf_column_name</span> <span class="op">=</span> <span class="st">'TleafCnd'</span>,</span>
<span>  <span class="va">ci_column_name</span> <span class="op">=</span> <span class="st">'Ci'</span>,</span>
<span>  <span class="va">qin_column_name</span> <span class="op">=</span> <span class="st">'Qin'</span>,</span>
<span>  <span class="va">rd_column_name</span> <span class="op">=</span> <span class="st">'Rd'</span>,</span>
<span>  <span class="va">useRd</span> <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  <span class="va">...</span> <span class="co"># additional named arguments to be passed to `fitaci`</span></span>
<span><span class="op">)</span></span>
<span><span class="op">{</span></span>
<span>  <span class="co">### Check inputs</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="../reference/is.exdf.html">is.exdf</a></span><span class="op">(</span><span class="va">replicate_exdf</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">'fit_c3_aci_plantecophys requires an exdf object'</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># Make sure the required variables are defined and have the correct units</span></span>
<span>  <span class="va">required_variables</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">required_variables</span><span class="op">[[</span><span class="va">a_column_name</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">'micromol m^(-2) s^(-1)'</span></span>
<span>  <span class="va">required_variables</span><span class="op">[[</span><span class="va">tleaf_column_name</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"degrees C"</span></span>
<span>  <span class="va">required_variables</span><span class="op">[[</span><span class="va">ci_column_name</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">'micromol mol^(-1)'</span></span>
<span>  <span class="va">required_variables</span><span class="op">[[</span><span class="va">qin_column_name</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">'micromol m^(-2) s^(-1)'</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">useRd</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Only check the existence and units of the `Rd` column if it will be used</span></span>
<span>    <span class="va">required_variables</span><span class="op">[[</span><span class="va">rd_column_name</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">'micromol m^(-2) s^(-1)'</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="fu"><a href="../reference/check_required_variables.html">check_required_variables</a></span><span class="op">(</span><span class="va">replicate_exdf</span>, <span class="va">required_variables</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Make sure the user didn't supply their own `varnames` because we will</span></span>
<span>  <span class="co"># automatically define it from the other column name inputs</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="st">'varnames'</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">...</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">'do not supply `varnames` when calling fit_c3_aci_plantecophys'</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co">### Call function from external packge with appropriate units</span></span>
<span></span>
<span>  <span class="va">fit_res</span> <span class="op">&lt;-</span> <span class="fu">plantecophys</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/plantecophys/man/fitaci.html" class="external-link">fitaci</a></span><span class="op">(</span></span>
<span>    <span class="va">replicate_exdf</span><span class="op">$</span><span class="va">main_data</span>,</span>
<span>    varnames <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        ALEAF <span class="op">=</span> <span class="va">a_column_name</span>,</span>
<span>        Tleaf <span class="op">=</span> <span class="va">tleaf_column_name</span>,</span>
<span>        Ci <span class="op">=</span> <span class="va">ci_column_name</span>,</span>
<span>        PPFD <span class="op">=</span> <span class="va">qin_column_name</span>,</span>
<span>        Rd <span class="op">=</span> <span class="va">rd_column_name</span></span>
<span>    <span class="op">)</span>,</span>
<span>    useRd <span class="op">=</span> <span class="va">useRd</span>,</span>
<span>    <span class="va">...</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co">### Collect outputs</span></span>
<span></span>
<span>  <span class="co"># Get the identifier columns from the original exdf object</span></span>
<span>  <span class="va">replicate_identifiers</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/identifier_columns.html">identifier_columns</a></span><span class="op">(</span><span class="va">replicate_exdf</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Get a data frame with the fitted values of assimilation and convert it to an</span></span>
<span>  <span class="co"># `exdf` object, setting the category to `fit_c3_aci_plantecophys` and</span></span>
<span>  <span class="co"># specifying the units for each column</span></span>
<span>  <span class="va">fits</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/exdf.html">exdf</a></span><span class="op">(</span><span class="va">fit_res</span><span class="op">$</span><span class="va">df</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">fits</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/document_variables.html">document_variables</a></span><span class="op">(</span></span>
<span>    <span class="va">fits</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'fit_c3_aci_plantecophys'</span>, <span class="st">'Ci'</span>,          <span class="st">'micromol mol^(-1)'</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'fit_c3_aci_plantecophys'</span>, <span class="st">'Ameas'</span>,       <span class="st">'micromol m^(-2) s^(-1)'</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'fit_c3_aci_plantecophys'</span>, <span class="st">'Amodel'</span>,      <span class="st">'micromol m^(-2) s^(-1)'</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'fit_c3_aci_plantecophys'</span>, <span class="st">'Ac'</span>,          <span class="st">'micromol m^(-2) s^(-1)'</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'fit_c3_aci_plantecophys'</span>, <span class="st">'Aj'</span>,          <span class="st">'micromol m^(-2) s^(-1)'</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'fit_c3_aci_plantecophys'</span>, <span class="st">'Ap'</span>,          <span class="st">'micromol m^(-2) s^(-1)'</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'fit_c3_aci_plantecophys'</span>, <span class="st">'Rd'</span>,          <span class="st">'micromol m^(-2) s^(-1)'</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'fit_c3_aci_plantecophys'</span>, <span class="st">'VPD'</span>,         <span class="st">'kPa'</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'fit_c3_aci_plantecophys'</span>, <span class="st">'Tleaf'</span>,       <span class="st">'degrees C'</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'fit_c3_aci_plantecophys'</span>, <span class="st">'Cc'</span>,          <span class="st">'micromol mol^(-1)'</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'fit_c3_aci_plantecophys'</span>, <span class="st">'PPFD'</span>,        <span class="st">'micromol m^(-2) s^(-1)'</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'fit_c3_aci_plantecophys'</span>, <span class="st">'Patm'</span>,        <span class="st">'kPa'</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'fit_c3_aci_plantecophys'</span>, <span class="st">'Ci_original'</span>, <span class="st">'micromol mol^(-1)'</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Append the identifier columns to the fits</span></span>
<span>  <span class="va">fits</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">replicate_identifiers</span>, <span class="va">fits</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># `plantecophys::fitaci` returns absurdly high values of `Ap` when it cannot</span></span>
<span>  <span class="co"># get a good estimate for `Tp`. These can cause problems when plotting the</span></span>
<span>  <span class="co"># results, so we replace any `Ap` values above 500 micromol / m^2 / s with</span></span>
<span>  <span class="co"># NA.</span></span>
<span>  <span class="va">fits</span><span class="op">[</span><span class="va">fits</span><span class="op">[</span>, <span class="st">'Ap'</span><span class="op">]</span> <span class="op">&gt;</span> <span class="fl">500</span>, <span class="st">'Ap'</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span></span>
<span>  <span class="co"># Convert `plantecophys::fitaci` outputs to net CO2 assimilation rates for</span></span>
<span>  <span class="co"># consistency with `fit_c3_aci`.</span></span>
<span>  <span class="va">fits</span><span class="op">[</span>, <span class="st">'Ac'</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">fits</span><span class="op">[</span>, <span class="st">'Ac'</span><span class="op">]</span> <span class="op">-</span> <span class="va">fits</span><span class="op">[</span>, <span class="st">'Rd'</span><span class="op">]</span></span>
<span>  <span class="va">fits</span><span class="op">[</span>, <span class="st">'Aj'</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">fits</span><span class="op">[</span>, <span class="st">'Aj'</span><span class="op">]</span> <span class="op">-</span> <span class="va">fits</span><span class="op">[</span>, <span class="st">'Rd'</span><span class="op">]</span></span>
<span>  <span class="va">fits</span><span class="op">[</span>, <span class="st">'Ap'</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">fits</span><span class="op">[</span>, <span class="st">'Ap'</span><span class="op">]</span> <span class="op">-</span> <span class="va">fits</span><span class="op">[</span>, <span class="st">'Rd'</span><span class="op">]</span></span>
<span></span>
<span>  <span class="co"># Add a column for the residuals</span></span>
<span>  <span class="va">fits</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/set_variable.html">set_variable</a></span><span class="op">(</span></span>
<span>    <span class="va">fits</span>,</span>
<span>    <span class="st">'A_residuals'</span>,</span>
<span>    <span class="st">'micromol m^(-2) s^(-1)'</span>,</span>
<span>    <span class="st">'fit_c3_aci_plantecophys'</span>,</span>
<span>    <span class="va">fits</span><span class="op">[</span>, <span class="st">'Ameas'</span><span class="op">]</span> <span class="op">-</span> <span class="va">fits</span><span class="op">[</span>, <span class="st">'Amodel'</span><span class="op">]</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Create an exdf object with the parameter values that are included in the</span></span>
<span>  <span class="co"># fitting result. Note that we do not include RMSE because it is not</span></span>
<span>  <span class="co"># calculated correctly.</span></span>
<span>  <span class="va">parameters</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/exdf.html">exdf</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    Ci_transition  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">fit_res</span><span class="op">$</span><span class="va">Ci_transition</span><span class="op">)</span>,</span>
<span>    Ci_transition2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">fit_res</span><span class="op">$</span><span class="va">Ci_transition2</span><span class="op">)</span>,</span>
<span>    Tcorrect       <span class="op">=</span> <span class="va">fit_res</span><span class="op">$</span><span class="va">Tcorrect</span>,</span>
<span>    Rd_measured    <span class="op">=</span> <span class="va">fit_res</span><span class="op">$</span><span class="va">Rd_measured</span>,</span>
<span>    GammaStar      <span class="op">=</span> <span class="va">fit_res</span><span class="op">$</span><span class="va">GammaStar</span>,</span>
<span>    Km             <span class="op">=</span> <span class="va">fit_res</span><span class="op">$</span><span class="va">Km</span>,</span>
<span>    kminput        <span class="op">=</span> <span class="va">fit_res</span><span class="op">$</span><span class="va">kminput</span>,</span>
<span>    gstarinput     <span class="op">=</span> <span class="va">fit_res</span><span class="op">$</span><span class="va">gstarinput</span>,</span>
<span>    fitmethod      <span class="op">=</span> <span class="va">fit_res</span><span class="op">$</span><span class="va">fitmethod</span>,</span>
<span>    citransition   <span class="op">=</span> <span class="va">fit_res</span><span class="op">$</span><span class="va">citransition</span>,</span>
<span>    gmeso          <span class="op">=</span> <span class="va">fit_res</span><span class="op">$</span><span class="va">gmeso</span>,</span>
<span>    fitTPU         <span class="op">=</span> <span class="va">fit_res</span><span class="op">$</span><span class="va">fitTPU</span>,</span>
<span>    alphag         <span class="op">=</span> <span class="va">fit_res</span><span class="op">$</span><span class="va">alphag</span>,</span>
<span>    Vcmax          <span class="op">=</span> <span class="va">fit_res</span><span class="op">$</span><span class="va">par</span><span class="op">[</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">]</span>,</span>
<span>    Vcmax_err      <span class="op">=</span> <span class="va">fit_res</span><span class="op">$</span><span class="va">par</span><span class="op">[</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">]</span>,</span>
<span>    Jmax           <span class="op">=</span> <span class="va">fit_res</span><span class="op">$</span><span class="va">par</span><span class="op">[</span><span class="fl">2</span>, <span class="fl">1</span><span class="op">]</span>,</span>
<span>    Jmax_err       <span class="op">=</span> <span class="va">fit_res</span><span class="op">$</span><span class="va">par</span><span class="op">[</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">]</span>,</span>
<span>    Rd             <span class="op">=</span> <span class="va">fit_res</span><span class="op">$</span><span class="va">par</span><span class="op">[</span><span class="fl">3</span>, <span class="fl">1</span><span class="op">]</span>,</span>
<span>    Rd_err         <span class="op">=</span> <span class="va">fit_res</span><span class="op">$</span><span class="va">par</span><span class="op">[</span><span class="fl">3</span>, <span class="fl">2</span><span class="op">]</span>,</span>
<span>    ci_star        <span class="op">=</span> <span class="va">fit_res</span><span class="op">$</span><span class="fu">Ci</span><span class="op">(</span><span class="fl">0</span><span class="op">)</span>,</span>
<span>    A_transition   <span class="op">=</span> <span class="va">fit_res</span><span class="op">$</span><span class="fu">Photosyn</span><span class="op">(</span>Ci<span class="op">=</span><span class="va">fit_res</span><span class="op">$</span><span class="va">Ci_transition</span><span class="op">)</span><span class="op">$</span><span class="va">ALEAF</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># The value of `Tp` and its error will depend on `fitTPU`</span></span>
<span>  <span class="va">parameters</span><span class="op">[</span>, <span class="st">'Tp'</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="kw">if</span> <span class="op">(</span><span class="va">fit_res</span><span class="op">$</span><span class="va">fitTPU</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">fit_res</span><span class="op">$</span><span class="va">par</span><span class="op">[</span><span class="fl">4</span>, <span class="fl">1</span><span class="op">]</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="cn">NA</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="va">parameters</span><span class="op">[</span>, <span class="st">'TPU_err'</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="kw">if</span> <span class="op">(</span><span class="va">fit_res</span><span class="op">$</span><span class="va">fitTPU</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">fit_res</span><span class="op">$</span><span class="va">par</span><span class="op">[</span><span class="fl">4</span>, <span class="fl">2</span><span class="op">]</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="cn">NA</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># Document the parameter units</span></span>
<span>  <span class="va">parameters</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/document_variables.html">document_variables</a></span><span class="op">(</span></span>
<span>    <span class="va">parameters</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'fit_c3_aci_plantecophys'</span>, <span class="st">'Ci_transition'</span>,  <span class="st">'micromol mol^(-1)'</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'fit_c3_aci_plantecophys'</span>, <span class="st">'Ci_transition2'</span>, <span class="st">'micromol mol^(-1)'</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'fit_c3_aci_plantecophys'</span>, <span class="st">'Tcorrect'</span>,       <span class="st">''</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'fit_c3_aci_plantecophys'</span>, <span class="st">'Rd_measured'</span>,    <span class="st">''</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'fit_c3_aci_plantecophys'</span>, <span class="st">'GammaStar'</span>,      <span class="st">'micromol mol^(-1)'</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'fit_c3_aci_plantecophys'</span>, <span class="st">'Km'</span>,             <span class="st">'micromol mol^(-1)'</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'fit_c3_aci_plantecophys'</span>, <span class="st">'kminput'</span>,        <span class="st">''</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'fit_c3_aci_plantecophys'</span>, <span class="st">'gstarinput'</span>,     <span class="st">''</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'fit_c3_aci_plantecophys'</span>, <span class="st">'fitmethod'</span>,      <span class="st">''</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'fit_c3_aci_plantecophys'</span>, <span class="st">'citransition'</span>,   <span class="st">'micromol mol^(-1)'</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'fit_c3_aci_plantecophys'</span>, <span class="st">'gmeso'</span>,          <span class="st">'mol m^(-2) s^(-1)'</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'fit_c3_aci_plantecophys'</span>, <span class="st">'fitTPU'</span>,         <span class="st">''</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'fit_c3_aci_plantecophys'</span>, <span class="st">'alphag'</span>,         <span class="st">'dimensionless'</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'fit_c3_aci_plantecophys'</span>, <span class="st">'Vcmax'</span>,          <span class="st">'micromol m^(-2) s^(-1)'</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'fit_c3_aci_plantecophys'</span>, <span class="st">'Vcmax_err'</span>,      <span class="st">'micromol m^(-2) s^(-1)'</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'fit_c3_aci_plantecophys'</span>, <span class="st">'Jmax'</span>,           <span class="st">'micromol m^(-2) s^(-1)'</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'fit_c3_aci_plantecophys'</span>, <span class="st">'Jmax_err'</span>,       <span class="st">'micromol m^(-2) s^(-1)'</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'fit_c3_aci_plantecophys'</span>, <span class="st">'Rd'</span>,             <span class="st">'micromol m^(-2) s^(-1)'</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'fit_c3_aci_plantecophys'</span>, <span class="st">'Rd_err'</span>,         <span class="st">'micromol m^(-2) s^(-1)'</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'fit_c3_aci_plantecophys'</span>, <span class="st">'Tp'</span>,             <span class="st">'micromol m^(-2) s^(-1)'</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'fit_c3_aci_plantecophys'</span>, <span class="st">'TPU_err'</span>,        <span class="st">'micromol m^(-2) s^(-1)'</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'fit_c3_aci_plantecophys'</span>, <span class="st">'ci_star'</span>,        <span class="st">'micromol mol^(-1)'</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'fit_c3_aci_plantecophys'</span>, <span class="st">'A_transition'</span>,   <span class="st">'micromol m^(-2) s^(-1)'</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Append the identifier columns to the parameters</span></span>
<span>  <span class="va">parameters</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">replicate_identifiers</span>, <span class="va">parameters</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Return a list of two data frames: `fits` and `parameters`</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      fits <span class="op">=</span> <span class="va">fits</span>,</span>
<span>      parameters <span class="op">=</span> <span class="va">parameters</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Fit each curve</span></span>
<span><span class="va">c3_aci_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/consolidate.html">consolidate</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/by.html" class="external-link">by</a></span><span class="op">(</span></span>
<span>  <span class="va">licor_data</span>,                       <span class="co"># The `exdf` object containing the curves</span></span>
<span>  <span class="va">licor_data</span><span class="op">[</span>, <span class="st">'curve_identifier'</span><span class="op">]</span>, <span class="co"># A factor used to split `licor_data` into chunks</span></span>
<span>  <span class="va">fit_c3_aci_plantecophys</span>           <span class="co"># The function to apply to each chunk of `licor_data`</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot each fit</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/lattice/man/xyplot.html" class="external-link">xyplot</a></span><span class="op">(</span></span>
<span>  <span class="va">Ameas</span> <span class="op">+</span> <span class="va">Ac</span> <span class="op">+</span> <span class="va">Aj</span> <span class="op">+</span> <span class="va">Ap</span> <span class="op">+</span> <span class="va">Amodel</span> <span class="op">~</span> <span class="va">Ci_original</span> <span class="op">|</span> <span class="va">curve_identifier</span>,</span>
<span>  data <span class="op">=</span> <span class="va">c3_aci_results</span><span class="op">$</span><span class="va">fits</span><span class="op">$</span><span class="va">main_data</span>,</span>
<span>  type <span class="op">=</span> <span class="st">'l'</span>,</span>
<span>  auto.key <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>space <span class="op">=</span> <span class="st">'right'</span><span class="op">)</span>,</span>
<span>  grid <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  xlab <span class="op">=</span> <span class="st">'Intercellular CO2 concentration (ppm)'</span>,</span>
<span>  ylab <span class="op">=</span> <span class="st">'Assimilation rate (micromol / m^2 / s)'</span>,</span>
<span>  par.settings <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    superpose.line <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>col <span class="op">=</span> <span class="fu"><a href="../reference/multi_curve_colors.html">multi_curve_colors</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    superpose.symbol <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>col <span class="op">=</span> <span class="fu"><a href="../reference/multi_curve_colors.html">multi_curve_colors</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># View the parameter values</span></span>
<span><span class="va">columns_for_viewing</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'instrument'</span>, <span class="st">'species'</span>, <span class="st">'plot'</span>, <span class="st">'Vcmax'</span>, <span class="st">'Jmax'</span>, <span class="st">'Rd'</span>, <span class="st">'Tp'</span><span class="op">)</span></span>
<span></span>
<span><span class="va">c3_aci_parameters</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">c3_aci_results</span><span class="op">$</span><span class="va">parameters</span><span class="op">[</span> , <span class="va">columns_for_viewing</span>, <span class="cn">TRUE</span><span class="op">]</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">c3_aci_parameters</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot the residuals</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/lattice/man/xyplot.html" class="external-link">xyplot</a></span><span class="op">(</span></span>
<span>  <span class="va">A_residuals</span> <span class="op">~</span> <span class="va">Ci_original</span> <span class="op">|</span> <span class="va">curve_identifier</span>,</span>
<span>  data <span class="op">=</span> <span class="va">c3_aci_results</span><span class="op">$</span><span class="va">fits</span><span class="op">$</span><span class="va">main_data</span>,</span>
<span>  type <span class="op">=</span> <span class="st">'b'</span>,</span>
<span>  pch <span class="op">=</span> <span class="fl">16</span>,</span>
<span>  grid <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  xlab <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">'Intercellular CO2 concentration ('</span>,</span>
<span>    <span class="va">c3_aci_results</span><span class="op">$</span><span class="va">fits</span><span class="op">$</span><span class="va">units</span><span class="op">$</span><span class="va">Ci_original</span>, <span class="st">')'</span><span class="op">)</span>,</span>
<span>  ylab <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">'Assimilation rate residual (measured - fitted)\n('</span>,</span>
<span>    <span class="va">c3_aci_results</span><span class="op">$</span><span class="va">fits</span><span class="op">$</span><span class="va">units</span><span class="op">$</span><span class="va">A_residuals</span>, <span class="st">')'</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Edward B. Lochocki, Coralie E. Salesse-Smith, Justin M. McGrath.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
