<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="PhotoGEA">
<title>Creating Your Own Processing Tools • PhotoGEA</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Creating Your Own Processing Tools">
<meta property="og:description" content="PhotoGEA">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    padding-top: 70px;

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-primary"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">PhotoGEA</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.9.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/PhotoGEA.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/analyzing_ball_berry_data.html">Analyzing Ball-Berry Data</a>
    <a class="dropdown-item" href="../articles/analyzing_c3_aci_curves.html">Analyzing C3 A-Ci Curves</a>
    <a class="dropdown-item" href="../articles/analyzing_c4_aci_curves.html">Analyzing C4 A-Ci Curves</a>
    <a class="dropdown-item" href="../articles/analyzing_gm_data.html">Analyzing Mesophyll Conductance Data</a>
    <a class="dropdown-item" href="../articles/analyzing_tdl_data.html">Analyzing TDL Data</a>
    <a class="dropdown-item" href="../articles/combining_with_other_packages.html">Combining PhotoGEA With Other Packages</a>
    <a class="dropdown-item" href="../articles/creating_your_own_processing_tools.html">Creating Your Own Processing Tools</a>
    <a class="dropdown-item" href="../articles/developing_a_data_analysis_pipeline.html">Developing a Data Analysis Pipeline</a>
    <a class="dropdown-item" href="../articles/working_with_extended_data_frames.html">Working With Extended Data Frames</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/eloch216/PhotoGEA/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Creating Your Own Processing Tools</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/eloch216/PhotoGEA/blob/HEAD/vignettes/creating_your_own_processing_tools.Rmd" class="external-link"><code>vignettes/creating_your_own_processing_tools.Rmd</code></a></small>
      <div class="d-none name"><code>creating_your_own_processing_tools.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h2>
<p>The <code>PhotoGEA</code> package contains many functions for
processing gas exchange data, such as <code>apply_gm</code> and
<code>fit_c3_aci</code>. (A complete list is available in the <a href="developing_a_data_analysis_pipeline.html">Developing a Data
Analysis Pipeline</a> vignette.) However, you may wish to perform some
kind of processing that is not already available from
<code>PhotoGEA</code>. In this case, it is possible to create your own
processing tools that will be compatible with the other functions in
<code>PhotoGEA</code> that help with loading data, validating data,
processing sets of multiple reponse curves, and analyzing the
results.</p>
<p>In this vignette, we will provide an example showing some of the best
practices for creating your own processing tools. If you create a tool
that may be useful to others and you would like to share it, contact the
<code>PhotoGEA</code> package maintainer about adding your function to
the package.</p>
</div>
<div class="section level2">
<h2 id="loading-packages">Loading Packages<a class="anchor" aria-label="anchor" href="#loading-packages"></a>
</h2>
<p>As always, the first step is to load the packages we will be using.
In addition to <code>PhotoGEA</code>, we will also use the
<code>lattice</code> package.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load required packages</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/eloch216/PhotoGEA" class="external-link">PhotoGEA</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://lattice.r-forge.r-project.org/" class="external-link">lattice</a></span><span class="op">)</span></span></code></pre></div>
<p>If the <code>lattice</code> package is not installed on your R setup,
you can install it by typing
<code>install.packages('lattice')</code>.</p>
</div>
<div class="section level2">
<h2 id="loading-and-validating-data">Loading and Validating Data<a class="anchor" aria-label="anchor" href="#loading-and-validating-data"></a>
</h2>
<p>For this example, we will load the same set of C<sub>3</sub> A-Ci
curves that are used in the <a href="analyzing_c3_aci_curves.html">Analyzing C3 A-Ci Curves</a>
vignette, and we will perform the same steps for organizing and cleaning
the data. See that vignette for more details about these steps. For
brevity, the commands are not included here, but they can be found at
the end of this vignette in <a href="#commands-from-this-document">Commands From This Document</a>.</p>
</div>
<div class="section level2">
<h2 id="choosing-a-model-to-use">Choosing a Model To Use<a class="anchor" aria-label="anchor" href="#choosing-a-model-to-use"></a>
</h2>
<p>For this example, we will develop a function that fits a rectangular
hyperbola to an A-Ci curve. A rectangular hyperbola is an equation of
the form <code>f(x) = y_max * x / (x + x_half)</code>. We can understand
a great deal about this type of equation by examining its form:</p>
<ul>
<li>When <code>x</code> is very large, <code>x + x_half</code> can be
approximated as <code>x</code>, so in this case, the function reduces to
<code>y_max * x / x = y_max</code>. In other words, the function reaches
a constant value of <code>y_max</code> when <code>x</code> is
large.</li>
<li>When <code>x</code> is <code>x_half</code>, the function’s value is
<code>y_max * x_half / (x_half +   x_half) = y_max / 2</code>. In other
words, <code>x_half</code> is the value of <code>x</code> where the
function reaches half of its maximum value.</li>
<li>When <code>x</code> is small, <code>x + x_half</code> can be
approximated by <code>x_half</code>. In this case, the function reduces
to <code>y_max * x / x_half</code>. In other words, the function is a
straight line with slope <code>y_max / x_half</code> when <code>x</code>
is small.</li>
<li>When <code>x</code> is exactly zero, the function is also zero.</li>
</ul>
<p>With this in mind, we can see that a rectangular hyperbola begins
with a linear portion and flattens out to a constant value. This is
generally similar to the shape of an A-Ci curve, so it might be
reasonable to use this equation for fitting. This type of model would be
characterized as an “empirical” model (in contrast to a mechanistic or
process-based model) because there is no underlying explanation for why
this equation should be a good fit. Thus, it could be considered to be a
simpler alternative to the Farquhar-von-Caemmerer-Berry model used in
the <code>fit_c3_aci</code> function.</p>
<p>When applying this to an A-Ci curve, we will want to replace the
independent variable <code>x</code> with <code>Ci</code> and the
calculated value with the net assimilation <code>A</code>. One caveat is
that <code>A</code> is generally negative when <code>Ci</code> is zero
or very low, but the rectangular hyperbola never returns negative
values. To get a better fit, it will be helpful to include respiration
as a constant value subtracted from the hyperbola:
<code>A = A_max * Ci / (Ci + Ci_half) - Rd</code>.</p>
</div>
<div class="section level2">
<h2 id="general-suggestions-for-photogea-fitting-functions">General Suggestions for PhotoGEA Fitting Functions<a class="anchor" aria-label="anchor" href="#general-suggestions-for-photogea-fitting-functions"></a>
</h2>
<p>When creating a <code>PhotoGEA</code> fitting function, it is a good
idea to follow these rules, which will ensure that the function is
compatible with <code>by + consolidate</code> and has similar inputs and
outputs to other fitting functions:</p>
<ul>
<li>The first input argument should be an <code>exdf</code> object that
represents one “unit” of data; in this case, a single A-Ci curve. This
argument is often called <code>replicate_exdf</code> as a reminder of
what it represents and what type of object it should be.</li>
<li>The first argument should be checked to make sure it is an
<code>exdf</code>; this can be done using <code>is.exdf</code>.</li>
<li>The name of each important column from the <code>exdf</code> object
should be passed as an input argument with a default value.</li>
<li>The function should check to make sure each important column is in
the <code>exdf</code> object and that it has the expected units; this
check can be accomplished with the <code>check_required_variables</code>
function from <code>PhotoGEA</code>.</li>
<li>The function should return a list of named <code>exdf</code> objects
as its outputs; most fitting functions return <code>exdf</code> objects
called <code>fits</code> and <code>parameters</code>.</li>
<li>The <code>fits</code> return object should be a copy of the original
data with additional columns for the fitted values and the fit
residuals.</li>
<li>The <code>parameters</code> return object should have one row, and
three different types of columns:
<ul>
<li>Some of its columns should include identifying information about the
curve such as <code>species</code> or <code>event</code>; this
information can be obtained with the <code>identifier_columns</code>
function from <code>PhotoGEA</code>.</li>
<li>Some of its columns should include statistics that describe the
quality of the fit, such as the root mean squared error; this
information can be obtained with the <code>residual_stats</code>
function from <code>PhotoGEA</code>.</li>
<li>The other columns should include the best-fit values of the model’s
parameters and any other information that may be important to the
user.</li>
</ul>
</li>
<li>Any <code>exdf</code> objects returned by the function should be
fully documented with units for each relevant column.</li>
<li>The category for each <code>exdf</code> column created by the
function should be set to its name to provide a record of how the column
was calculated.</li>
<li>Any problems detected while checking the inputs should cause
errors.</li>
<li>If a fit fails, the function should return <code>NA</code> results
rather than causing an error. Otherwise, this will cause problems while
fitting many curves at once, since the process will be disrupted by any
errors that are thrown.</li>
<li>In general, the structure of the output (e.g. the number of
<code>exdf</code> objects in the list, the names of the
<code>exdf</code> objects in the list, and the columns in each
<code>exdf</code> object) should always be the same, no matter what the
function’s inputs are and no matter what the fitting results are. Any
outputs that are not relevant for a particular fit should just be set to
<code>NA</code>.</li>
<li>Provide default values for as many input arguments as possible. (No
default should be provided for <code>replicate_exdf</code>, of
course.)</li>
</ul>
<p>In the next section, we will create a fitting function that meets
these criteria.</p>
</div>
<div class="section level2">
<h2 id="writing-a-fitting-function">Writing A Fitting Function<a class="anchor" aria-label="anchor" href="#writing-a-fitting-function"></a>
</h2>
<p>Here we write a function that fits a rectangular hyperbola to an A-Ci
curve and follows the suggestions outlined above:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Define a custom fitting function</span></span>
<span><span class="va">fit_hyperbola</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span></span>
<span>  <span class="va">replicate_exdf</span>,</span>
<span>  <span class="va">a_column_name</span> <span class="op">=</span> <span class="st">'A'</span>,</span>
<span>  <span class="va">ci_column_name</span> <span class="op">=</span> <span class="st">'Ci'</span>,</span>
<span>  <span class="va">initial_guess</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>A_max <span class="op">=</span> <span class="fl">40</span>, Ci_half <span class="op">=</span> <span class="fl">100</span>, Rd <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="op">{</span></span>
<span>  <span class="co">### Check inputs</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="../reference/is.exdf.html">is.exdf</a></span><span class="op">(</span><span class="va">replicate_exdf</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"fit_hyperbola requires an exdf object"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># Make sure the required variables are defined and have the correct units</span></span>
<span>  <span class="va">required_variables</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">required_variables</span><span class="op">[[</span><span class="va">a_column_name</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"micromol m^(-2) s^(-1)"</span></span>
<span>  <span class="va">required_variables</span><span class="op">[[</span><span class="va">ci_column_name</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"micromol mol^(-1)"</span></span>
<span></span>
<span>  <span class="fu"><a href="../reference/check_required_variables.html">check_required_variables</a></span><span class="op">(</span><span class="va">replicate_exdf</span>, <span class="va">required_variables</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Extract the values of several important columns</span></span>
<span>  <span class="va">A</span> <span class="op">&lt;-</span> <span class="va">replicate_exdf</span><span class="op">[</span>, <span class="va">a_column_name</span><span class="op">]</span></span>
<span>  <span class="va">Ci</span> <span class="op">&lt;-</span> <span class="va">replicate_exdf</span><span class="op">[</span>, <span class="va">ci_column_name</span><span class="op">]</span></span>
<span></span>
<span>  <span class="co">### Perform processing operations</span></span>
<span></span>
<span>  <span class="co"># Wrap `stats::nls` in a `tryCatch` block so we can indicate fit failures by</span></span>
<span>  <span class="co"># setting `aci_fit` to `NULL`.</span></span>
<span>  <span class="va">aci_fit</span> <span class="op">&lt;-</span> <span class="kw"><a href="https://rdrr.io/r/base/conditions.html" class="external-link">tryCatch</a></span><span class="op">(</span></span>
<span>    <span class="op">{</span></span>
<span>      <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/nls.html" class="external-link">nls</a></span><span class="op">(</span><span class="va">A</span> <span class="op">~</span> <span class="va">A_max</span> <span class="op">*</span> <span class="va">Ci</span> <span class="op">/</span> <span class="op">(</span><span class="va">Ci</span> <span class="op">+</span> <span class="va">Ci_half</span><span class="op">)</span> <span class="op">-</span> <span class="va">Rd</span>, start <span class="op">=</span> <span class="va">initial_guess</span><span class="op">)</span></span>
<span>    <span class="op">}</span>,</span>
<span>    error <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">cond</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="st">'Having trouble fitting an A-Ci curve:'</span><span class="op">)</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="../reference/identifier_columns.html">identifier_columns</a></span><span class="op">(</span><span class="va">replicate_exdf</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="st">'Giving up on the fit :('</span><span class="op">)</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">cond</span><span class="op">)</span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="cn">NULL</span><span class="op">)</span></span>
<span>    <span class="op">}</span>,</span>
<span>    warning <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">cond</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="st">'Having trouble fitting an A-Ci curve:'</span><span class="op">)</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="../reference/identifier_columns.html">identifier_columns</a></span><span class="op">(</span><span class="va">replicate_exdf</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="st">'Giving up on the fit :('</span><span class="op">)</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">cond</span><span class="op">)</span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="cn">NULL</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co">### Collect and document outputs</span></span>
<span></span>
<span>  <span class="co"># Extract the fit results and add the fits and residuals to the exdf object</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">aci_fit</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">A_max</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span>        <span class="va">A_max_err</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span>        <span class="va">Ci_half</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span>        <span class="va">Ci_half_err</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span>        <span class="va">Rd</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span>        <span class="va">Rd_err</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span>        <span class="va">replicate_exdf</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">a_column_name</span>, <span class="st">'_fit'</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span>        <span class="va">replicate_exdf</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">a_column_name</span>, <span class="st">'_residuals'</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>        <span class="va">fit_summary</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">aci_fit</span><span class="op">)</span></span>
<span>        <span class="va">A_max</span> <span class="op">&lt;-</span> <span class="va">fit_summary</span><span class="op">$</span><span class="va">coefficients</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">]</span></span>
<span>        <span class="va">A_max_err</span> <span class="op">&lt;-</span> <span class="va">fit_summary</span><span class="op">$</span><span class="va">coefficients</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">]</span></span>
<span>        <span class="va">Ci_half</span> <span class="op">&lt;-</span> <span class="va">fit_summary</span><span class="op">$</span><span class="va">coefficients</span><span class="op">[</span><span class="fl">2</span>,<span class="fl">1</span><span class="op">]</span></span>
<span>        <span class="va">Ci_half_err</span> <span class="op">&lt;-</span> <span class="va">fit_summary</span><span class="op">$</span><span class="va">coefficients</span><span class="op">[</span><span class="fl">2</span>,<span class="fl">2</span><span class="op">]</span></span>
<span>        <span class="va">Rd</span> <span class="op">&lt;-</span> <span class="va">fit_summary</span><span class="op">$</span><span class="va">coefficients</span><span class="op">[</span><span class="fl">3</span>,<span class="fl">1</span><span class="op">]</span></span>
<span>        <span class="va">Rd_err</span> <span class="op">&lt;-</span> <span class="va">fit_summary</span><span class="op">$</span><span class="va">coefficients</span><span class="op">[</span><span class="fl">3</span>,<span class="fl">2</span><span class="op">]</span></span>
<span></span>
<span>        <span class="va">replicate_exdf</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">a_column_name</span>, <span class="st">'_fit'</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span></span>
<span>          <span class="va">A_max</span> <span class="op">*</span> <span class="va">Ci</span> <span class="op">/</span> <span class="op">(</span><span class="va">Ci</span> <span class="op">+</span> <span class="va">Ci_half</span><span class="op">)</span> <span class="op">-</span> <span class="va">Rd</span></span>
<span></span>
<span>        <span class="va">replicate_exdf</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">a_column_name</span>, <span class="st">'_residuals'</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span></span>
<span>          <span class="va">fit_summary</span><span class="op">$</span><span class="va">residuals</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="co"># Document the columns that were added to the replicate exdf</span></span>
<span>    <span class="va">replicate_exdf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/document_variables.html">document_variables</a></span><span class="op">(</span></span>
<span>        <span class="va">replicate_exdf</span>,</span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'fit_hyperbola'</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">a_column_name</span>, <span class="st">'_fit'</span><span class="op">)</span>,       <span class="st">'micromol m^(-2) s^(-1)'</span><span class="op">)</span>,</span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'fit_hyperbola'</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">a_column_name</span>, <span class="st">'_residuals'</span><span class="op">)</span>, <span class="st">'micromol m^(-2) s^(-1)'</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Get the replicate identifier columns</span></span>
<span>    <span class="va">replicate_identifiers</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/identifier_columns.html">identifier_columns</a></span><span class="op">(</span><span class="va">replicate_exdf</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Attach the residual stats to the identifiers</span></span>
<span>    <span class="va">replicate_identifiers</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span></span>
<span>        <span class="va">replicate_identifiers</span>,</span>
<span>        <span class="fu"><a href="../reference/residual_stats.html">residual_stats</a></span><span class="op">(</span></span>
<span>            <span class="va">replicate_exdf</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">a_column_name</span>, <span class="st">'_residuals'</span><span class="op">)</span><span class="op">]</span>,</span>
<span>            <span class="va">replicate_exdf</span><span class="op">$</span><span class="va">units</span><span class="op">[[</span><span class="va">a_column_name</span><span class="op">]</span><span class="op">]</span>,</span>
<span>            <span class="fl">3</span></span>
<span>        <span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Add the values of the fitted parameters</span></span>
<span>    <span class="va">replicate_identifiers</span><span class="op">[</span>, <span class="st">'A_max'</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">A_max</span></span>
<span>    <span class="va">replicate_identifiers</span><span class="op">[</span>, <span class="st">'A_max_err'</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">A_max_err</span></span>
<span>    <span class="va">replicate_identifiers</span><span class="op">[</span>, <span class="st">'Ci_half'</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">Ci_half</span></span>
<span>    <span class="va">replicate_identifiers</span><span class="op">[</span>, <span class="st">'Ci_half_err'</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">Ci_half_err</span></span>
<span>    <span class="va">replicate_identifiers</span><span class="op">[</span>, <span class="st">'Rd'</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">Rd</span></span>
<span>    <span class="va">replicate_identifiers</span><span class="op">[</span>, <span class="st">'Rd_err'</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">Rd_err</span></span>
<span></span>
<span>    <span class="co"># Document the columns that were added</span></span>
<span>    <span class="va">replicate_identifiers</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/document_variables.html">document_variables</a></span><span class="op">(</span></span>
<span>        <span class="va">replicate_identifiers</span>,</span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'fit_hyperbola'</span>, <span class="st">'A_max'</span>,       <span class="st">'micromol m^(-2) s^(-1)'</span><span class="op">)</span>,</span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'fit_hyperbola'</span>, <span class="st">'A_max_err'</span>,   <span class="st">'micromol m^(-2) s^(-1)'</span><span class="op">)</span>,</span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'fit_hyperbola'</span>, <span class="st">'Ci_half'</span>,     <span class="st">'micromol mol^(-1)'</span><span class="op">)</span>,</span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'fit_hyperbola'</span>, <span class="st">'Ci_half_err'</span>, <span class="st">'micromol mol^(-1)'</span><span class="op">)</span>,</span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'fit_hyperbola'</span>, <span class="st">'Rd'</span>,          <span class="st">'micromol m^(-2) s^(-1)'</span><span class="op">)</span>,</span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'fit_hyperbola'</span>, <span class="st">'Rd_err'</span>,      <span class="st">'micromol m^(-2) s^(-1)'</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      fits <span class="op">=</span> <span class="va">replicate_exdf</span>,</span>
<span>      parameters <span class="op">=</span> <span class="va">replicate_identifiers</span></span>
<span>    <span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Here we have split the code into three main sections corresponding to
the main steps that should be taken in any processing function:</p>
<ul>
<li>
<em>Check inputs</em>: Here we check the type of
<code>replicate_exdf</code> and the units of any columns that will be
accessed during the subsequent processing.</li>
<li>
<em>Perform processing operations</em>: Here we actually perform the
fit and get the results in their default form.</li>
<li>
<em>Collect and document outputs</em>: Here we reorganize the fit
results into two <code>exdf</code> objects corresponding to the fits and
parameters, and make sure that all units are documented. This section
ends by returning the results as a list of named <code>exdf</code>
objects.</li>
</ul>
<p>To make the fit, we have chosen to use <code>nls</code>, a function
from base R that performs nonlinear least-squares fitting. This function
is fairly straightforward to use, and it is quite popular. It requires
an initial guess for the values of the model’s parameters, so an
<code>initial_guess</code> input argument was included in
<code>fit_hyperbola</code> allowing the user to specify the starting
guess. One issue with <code>nls</code> is that it will throw an error if
the fit is not successful. Dealing with these possible errors
necessitates some extra code. First, we wrap the call to
<code>nls</code> in <code>tryCatch</code>, and then later we have to
decide what to return when there is a fit failure; here we just return
<code>NA</code> for all the variables normally determined from the
fitting procedure.</p>
<p>One improvement that could be made is to provide a way to generate a
better initial guess for the starting parameter values, but we have left
it out for brevity.</p>
</div>
<div class="section level2">
<h2 id="using-the-fitting-function">Using the Fitting Function<a class="anchor" aria-label="anchor" href="#using-the-fitting-function"></a>
</h2>
<p>Now we can use the new fitting just as we would use any other
processing function from <code>PhotoGEA</code>. Here we will use it to
fit all the response curves in the example data set, and then examine
the results by plotting the fits, plotting the residuals, and viewing
the parameter values. These commands are nearly identical to ones from
the <a href="analyzing_c3_aci_curves.html">Analyzing C3 A-Ci Curves</a>
vignette.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Fit each curve</span></span>
<span><span class="va">c3_aci_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/consolidate.html">consolidate</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/by.html" class="external-link">by</a></span><span class="op">(</span></span>
<span>  <span class="va">licor_data</span>,                       <span class="co"># The `exdf` object containing the curves</span></span>
<span>  <span class="va">licor_data</span><span class="op">[</span>, <span class="st">'curve_identifier'</span><span class="op">]</span>, <span class="co"># A factor used to split `licor_data` into chunks</span></span>
<span>  <span class="va">fit_hyperbola</span>                     <span class="co"># The function to apply to each chunk of `licor_data`</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot each fit</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/lattice/man/xyplot.html" class="external-link">xyplot</a></span><span class="op">(</span></span>
<span>  <span class="va">A</span> <span class="op">+</span> <span class="va">A_fit</span> <span class="op">~</span> <span class="va">Ci</span> <span class="op">|</span> <span class="va">curve_identifier</span>,</span>
<span>  data <span class="op">=</span> <span class="va">c3_aci_results</span><span class="op">$</span><span class="va">fits</span><span class="op">$</span><span class="va">main_data</span>,</span>
<span>  type <span class="op">=</span> <span class="st">'l'</span>,</span>
<span>  auto.key <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>space <span class="op">=</span> <span class="st">'right'</span><span class="op">)</span>,</span>
<span>  grid <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  xlab <span class="op">=</span> <span class="st">'Intercellular CO2 concentration (ppm)'</span>,</span>
<span>  ylab <span class="op">=</span> <span class="st">'Assimilation rate (micromol / m^2 / s)'</span>,</span>
<span>  par.settings <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    superpose.line <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>col <span class="op">=</span> <span class="fu"><a href="../reference/multi_curve_colors.html">multi_curve_colors</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    superpose.symbol <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>col <span class="op">=</span> <span class="fu"><a href="../reference/multi_curve_colors.html">multi_curve_colors</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="creating_your_own_processing_tools_files/figure-html/make_and_examine_fit-1.png" width="720" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Plot the residuals</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/lattice/man/xyplot.html" class="external-link">xyplot</a></span><span class="op">(</span></span>
<span>  <span class="va">A_residuals</span> <span class="op">~</span> <span class="va">Ci</span> <span class="op">|</span> <span class="va">curve_identifier</span>,</span>
<span>  data <span class="op">=</span> <span class="va">c3_aci_results</span><span class="op">$</span><span class="va">fits</span><span class="op">$</span><span class="va">main_data</span>,</span>
<span>  type <span class="op">=</span> <span class="st">'b'</span>,</span>
<span>  pch <span class="op">=</span> <span class="fl">16</span>,</span>
<span>  grid <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  xlab <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">'Intercellular CO2 concentration ('</span>,</span>
<span>    <span class="va">c3_aci_results</span><span class="op">$</span><span class="va">fits</span><span class="op">$</span><span class="va">units</span><span class="op">$</span><span class="va">Ci</span>, <span class="st">')'</span><span class="op">)</span>,</span>
<span>  ylab <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">'Assimilation rate residual (measured - fitted)\n('</span>,</span>
<span>    <span class="va">c3_aci_results</span><span class="op">$</span><span class="va">fits</span><span class="op">$</span><span class="va">units</span><span class="op">$</span><span class="va">A_residuals</span>, <span class="st">')'</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="creating_your_own_processing_tools_files/figure-html/make_and_examine_fit-2.png" width="720" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># View the parameter values</span></span>
<span><span class="va">columns_for_viewing</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'instrument'</span>, <span class="st">'species'</span>, <span class="st">'plot'</span>, <span class="st">'A_max'</span>, <span class="st">'Ci_half'</span>, <span class="st">'Rd'</span>, <span class="st">'RMSE'</span><span class="op">)</span></span>
<span></span>
<span><span class="va">c3_aci_parameters</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">c3_aci_results</span><span class="op">$</span><span class="va">parameters</span><span class="op">[</span> , <span class="va">columns_for_viewing</span>, <span class="cn">TRUE</span><span class="op">]</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">c3_aci_parameters</span><span class="op">)</span></span>
<span><span class="co">#&gt;   instrument [UserDefCon] (NA) species [UserDefCon] (NA) plot [UserDefCon] (NA)</span></span>
<span><span class="co">#&gt; 1                        ripe1                   soybean                     5a</span></span>
<span><span class="co">#&gt; 2                        ripe1                   tobacco                      1</span></span>
<span><span class="co">#&gt; 3                        ripe1                   tobacco                      2</span></span>
<span><span class="co">#&gt; 4                        ripe2                   soybean                      1</span></span>
<span><span class="co">#&gt; 5                        ripe2                   soybean                     5b</span></span>
<span><span class="co">#&gt; 6                        ripe2                   tobacco                      4</span></span>
<span><span class="co">#&gt;   A_max [fit_hyperbola] (micromol m^(-2) s^(-1))</span></span>
<span><span class="co">#&gt; 1                                      128.99658</span></span>
<span><span class="co">#&gt; 2                                      115.27665</span></span>
<span><span class="co">#&gt; 3                                      108.00753</span></span>
<span><span class="co">#&gt; 4                                       67.50371</span></span>
<span><span class="co">#&gt; 5                                       82.51852</span></span>
<span><span class="co">#&gt; 6                                       74.40789</span></span>
<span><span class="co">#&gt;   Ci_half [fit_hyperbola] (micromol mol^(-1))</span></span>
<span><span class="co">#&gt; 1                                    560.2505</span></span>
<span><span class="co">#&gt; 2                                    286.3507</span></span>
<span><span class="co">#&gt; 3                                    380.7208</span></span>
<span><span class="co">#&gt; 4                                    146.5151</span></span>
<span><span class="co">#&gt; 5                                    303.7394</span></span>
<span><span class="co">#&gt; 6                                    211.0452</span></span>
<span><span class="co">#&gt;   Rd [fit_hyperbola] (micromol m^(-2) s^(-1))</span></span>
<span><span class="co">#&gt; 1                                    11.89748</span></span>
<span><span class="co">#&gt; 2                                    20.57574</span></span>
<span><span class="co">#&gt; 3                                    14.89457</span></span>
<span><span class="co">#&gt; 4                                    19.17675</span></span>
<span><span class="co">#&gt; 5                                    13.73897</span></span>
<span><span class="co">#&gt; 6                                    17.46451</span></span>
<span><span class="co">#&gt;   RMSE [residual_stats] (micromol m^(-2) s^(-1))</span></span>
<span><span class="co">#&gt; 1                                       2.857247</span></span>
<span><span class="co">#&gt; 2                                       1.753694</span></span>
<span><span class="co">#&gt; 3                                       1.578398</span></span>
<span><span class="co">#&gt; 4                                       4.260341</span></span>
<span><span class="co">#&gt; 5                                       2.815101</span></span>
<span><span class="co">#&gt; 6                                       3.040083</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="more-examples">More Examples<a class="anchor" aria-label="anchor" href="#more-examples"></a>
</h2>
<p>Another example can be found in the <a href="combining_with_other_packages.html">Combining PhotoGEA With Other
Packages</a> vignette, which discusses how to write wrappers for
functions from other packages. Essentially, this is a specialized case
of the ideas discussed here in this vignette.</p>
<p>Additional examples can be found by accessing the source code for the
built-in processing functions provided with <code>PhotoGEA</code>. One
way to see the code is to simply type the name of a function in the R
terminal; for example, <code>fit_ball_berry</code>. Although this method
is convenient, the downside is that any comments in the original code
will not be included. An alternate way is to view the code on GitHub,
where all the comments will be retained. For example, the source code
for <code>fit_ball_berry</code> can be found by accessing the <a href="https://github.com/eloch216/PhotoGEA/" class="external-link">PhotoGEA GitHub page</a>
and navigating to <a href="https://github.com/eloch216/PhotoGEA/blob/main/R/fit_ball_berry.R" class="external-link">R/fit_ball_berry.R</a>.</p>
</div>
<div class="section level2">
<h2 id="commands-from-this-document">Commands From This Document<a class="anchor" aria-label="anchor" href="#commands-from-this-document"></a>
</h2>
<p>The following code chunk includes all the central commands used
throughout this document. They are compiled here to make them easy to
copy/paste into a text file to initialize your own script.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load required packages</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/eloch216/PhotoGEA" class="external-link">PhotoGEA</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://lattice.r-forge.r-project.org/" class="external-link">lattice</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Define a vector of paths to the files we wish to load</span></span>
<span><span class="va">file_paths</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">'extdata'</span>, <span class="st">'c3_aci_1.xlsx'</span>, package <span class="op">=</span> <span class="st">'PhotoGEA'</span>, mustWork <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">'extdata'</span>, <span class="st">'c3_aci_2.xlsx'</span>, package <span class="op">=</span> <span class="st">'PhotoGEA'</span>, mustWork <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Load each file, storing the result in a list</span></span>
<span><span class="va">licor_exdf_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">file_paths</span>, <span class="kw">function</span><span class="op">(</span><span class="va">fpath</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/read_gasex_file.html">read_gasex_file</a></span><span class="op">(</span><span class="va">fpath</span>, <span class="st">'time'</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Get the names of all columns that are present in all of the Licor files</span></span>
<span><span class="va">columns_to_keep</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">identify_common_columns</span>, <span class="va">licor_exdf_list</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Extract just these columns</span></span>
<span><span class="va">licor_exdf_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">licor_exdf_list</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">x</span><span class="op">[</span> , <span class="va">columns_to_keep</span>, <span class="cn">TRUE</span><span class="op">]</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Use `rbind` to combine all the data</span></span>
<span><span class="va">licor_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="va">licor_exdf_list</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create a new identifier column formatted like `instrument - species - plot`</span></span>
<span><span class="va">licor_data</span><span class="op">[</span> , <span class="st">'curve_identifier'</span><span class="op">]</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">licor_data</span><span class="op">[</span> , <span class="st">'instrument'</span><span class="op">]</span>, <span class="st">'-'</span>, <span class="va">licor_data</span><span class="op">[</span> , <span class="st">'species'</span><span class="op">]</span>, <span class="st">'-'</span>, <span class="va">licor_data</span><span class="op">[</span> , <span class="st">'plot'</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Make sure the data meets basic requirements</span></span>
<span><span class="fu"><a href="../reference/check_licor_data.html">check_licor_data</a></span><span class="op">(</span><span class="va">licor_data</span>, <span class="st">'curve_identifier'</span>, <span class="fl">16</span>, <span class="st">'CO2_r_sp'</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Remove points with duplicated `CO2_r_sp` values and order by `Ci`</span></span>
<span><span class="va">licor_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/organize_response_curve_data.html">organize_response_curve_data</a></span><span class="op">(</span></span>
<span>    <span class="va">licor_data</span>,</span>
<span>    <span class="st">'curve_identifier'</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">9</span>, <span class="fl">10</span><span class="op">)</span>,</span>
<span>    <span class="st">'Ci'</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Only keep points where stability was achieved</span></span>
<span><span class="va">licor_data</span> <span class="op">&lt;-</span> <span class="va">licor_data</span><span class="op">[</span><span class="va">licor_data</span><span class="op">[</span>, <span class="st">'Stable'</span><span class="op">]</span> <span class="op">==</span> <span class="fl">2</span>, , <span class="cn">TRUE</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Remove any curves that have fewer than three remaining points</span></span>
<span><span class="va">npts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/by.html" class="external-link">by</a></span><span class="op">(</span><span class="va">licor_data</span>, <span class="va">licor_data</span><span class="op">[</span>, <span class="st">'curve_identifier'</span><span class="op">]</span>, <span class="va">nrow</span><span class="op">)</span></span>
<span><span class="va">ids_to_keep</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">npts</span><span class="op">[</span><span class="va">npts</span> <span class="op">&gt;</span> <span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">licor_data</span> <span class="op">&lt;-</span> <span class="va">licor_data</span><span class="op">[</span><span class="va">licor_data</span><span class="op">[</span>, <span class="st">'curve_identifier'</span><span class="op">]</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">ids_to_keep</span>, , <span class="cn">TRUE</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Remove points where `instrument` is `ripe1` and `CO2_r_sp` is 1800</span></span>
<span><span class="va">licor_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/remove_points.html">remove_points</a></span><span class="op">(</span></span>
<span>  <span class="va">licor_data</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>instrument <span class="op">=</span> <span class="st">'ripe1'</span>, CO2_r_sp <span class="op">=</span> <span class="fl">1800</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Define a custom fitting function</span></span>
<span><span class="va">fit_hyperbola</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span></span>
<span>  <span class="va">replicate_exdf</span>,</span>
<span>  <span class="va">a_column_name</span> <span class="op">=</span> <span class="st">'A'</span>,</span>
<span>  <span class="va">ci_column_name</span> <span class="op">=</span> <span class="st">'Ci'</span>,</span>
<span>  <span class="va">initial_guess</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>A_max <span class="op">=</span> <span class="fl">40</span>, Ci_half <span class="op">=</span> <span class="fl">100</span>, Rd <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="op">{</span></span>
<span>  <span class="co">### Check inputs</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="../reference/is.exdf.html">is.exdf</a></span><span class="op">(</span><span class="va">replicate_exdf</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"fit_hyperbola requires an exdf object"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># Make sure the required variables are defined and have the correct units</span></span>
<span>  <span class="va">required_variables</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">required_variables</span><span class="op">[[</span><span class="va">a_column_name</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"micromol m^(-2) s^(-1)"</span></span>
<span>  <span class="va">required_variables</span><span class="op">[[</span><span class="va">ci_column_name</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"micromol mol^(-1)"</span></span>
<span></span>
<span>  <span class="fu"><a href="../reference/check_required_variables.html">check_required_variables</a></span><span class="op">(</span><span class="va">replicate_exdf</span>, <span class="va">required_variables</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Extract the values of several important columns</span></span>
<span>  <span class="va">A</span> <span class="op">&lt;-</span> <span class="va">replicate_exdf</span><span class="op">[</span>, <span class="va">a_column_name</span><span class="op">]</span></span>
<span>  <span class="va">Ci</span> <span class="op">&lt;-</span> <span class="va">replicate_exdf</span><span class="op">[</span>, <span class="va">ci_column_name</span><span class="op">]</span></span>
<span></span>
<span>  <span class="co">### Perform processing operations</span></span>
<span></span>
<span>  <span class="co"># Wrap `stats::nls` in a `tryCatch` block so we can indicate fit failures by</span></span>
<span>  <span class="co"># setting `aci_fit` to `NULL`.</span></span>
<span>  <span class="va">aci_fit</span> <span class="op">&lt;-</span> <span class="kw"><a href="https://rdrr.io/r/base/conditions.html" class="external-link">tryCatch</a></span><span class="op">(</span></span>
<span>    <span class="op">{</span></span>
<span>      <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/nls.html" class="external-link">nls</a></span><span class="op">(</span><span class="va">A</span> <span class="op">~</span> <span class="va">A_max</span> <span class="op">*</span> <span class="va">Ci</span> <span class="op">/</span> <span class="op">(</span><span class="va">Ci</span> <span class="op">+</span> <span class="va">Ci_half</span><span class="op">)</span> <span class="op">-</span> <span class="va">Rd</span>, start <span class="op">=</span> <span class="va">initial_guess</span><span class="op">)</span></span>
<span>    <span class="op">}</span>,</span>
<span>    error <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">cond</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="st">'Having trouble fitting an A-Ci curve:'</span><span class="op">)</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="../reference/identifier_columns.html">identifier_columns</a></span><span class="op">(</span><span class="va">replicate_exdf</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="st">'Giving up on the fit :('</span><span class="op">)</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">cond</span><span class="op">)</span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="cn">NULL</span><span class="op">)</span></span>
<span>    <span class="op">}</span>,</span>
<span>    warning <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">cond</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="st">'Having trouble fitting an A-Ci curve:'</span><span class="op">)</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="../reference/identifier_columns.html">identifier_columns</a></span><span class="op">(</span><span class="va">replicate_exdf</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="st">'Giving up on the fit :('</span><span class="op">)</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">cond</span><span class="op">)</span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="cn">NULL</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co">### Collect and document outputs</span></span>
<span></span>
<span>  <span class="co"># Extract the fit results and add the fits and residuals to the exdf object</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">aci_fit</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">A_max</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span>        <span class="va">A_max_err</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span>        <span class="va">Ci_half</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span>        <span class="va">Ci_half_err</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span>        <span class="va">Rd</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span>        <span class="va">Rd_err</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span>        <span class="va">replicate_exdf</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">a_column_name</span>, <span class="st">'_fit'</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span>        <span class="va">replicate_exdf</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">a_column_name</span>, <span class="st">'_residuals'</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>        <span class="va">fit_summary</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">aci_fit</span><span class="op">)</span></span>
<span>        <span class="va">A_max</span> <span class="op">&lt;-</span> <span class="va">fit_summary</span><span class="op">$</span><span class="va">coefficients</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">]</span></span>
<span>        <span class="va">A_max_err</span> <span class="op">&lt;-</span> <span class="va">fit_summary</span><span class="op">$</span><span class="va">coefficients</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">]</span></span>
<span>        <span class="va">Ci_half</span> <span class="op">&lt;-</span> <span class="va">fit_summary</span><span class="op">$</span><span class="va">coefficients</span><span class="op">[</span><span class="fl">2</span>,<span class="fl">1</span><span class="op">]</span></span>
<span>        <span class="va">Ci_half_err</span> <span class="op">&lt;-</span> <span class="va">fit_summary</span><span class="op">$</span><span class="va">coefficients</span><span class="op">[</span><span class="fl">2</span>,<span class="fl">2</span><span class="op">]</span></span>
<span>        <span class="va">Rd</span> <span class="op">&lt;-</span> <span class="va">fit_summary</span><span class="op">$</span><span class="va">coefficients</span><span class="op">[</span><span class="fl">3</span>,<span class="fl">1</span><span class="op">]</span></span>
<span>        <span class="va">Rd_err</span> <span class="op">&lt;-</span> <span class="va">fit_summary</span><span class="op">$</span><span class="va">coefficients</span><span class="op">[</span><span class="fl">3</span>,<span class="fl">2</span><span class="op">]</span></span>
<span></span>
<span>        <span class="va">replicate_exdf</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">a_column_name</span>, <span class="st">'_fit'</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span></span>
<span>          <span class="va">A_max</span> <span class="op">*</span> <span class="va">Ci</span> <span class="op">/</span> <span class="op">(</span><span class="va">Ci</span> <span class="op">+</span> <span class="va">Ci_half</span><span class="op">)</span> <span class="op">-</span> <span class="va">Rd</span></span>
<span></span>
<span>        <span class="va">replicate_exdf</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">a_column_name</span>, <span class="st">'_residuals'</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span></span>
<span>          <span class="va">fit_summary</span><span class="op">$</span><span class="va">residuals</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="co"># Document the columns that were added to the replicate exdf</span></span>
<span>    <span class="va">replicate_exdf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/document_variables.html">document_variables</a></span><span class="op">(</span></span>
<span>        <span class="va">replicate_exdf</span>,</span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'fit_hyperbola'</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">a_column_name</span>, <span class="st">'_fit'</span><span class="op">)</span>,       <span class="st">'micromol m^(-2) s^(-1)'</span><span class="op">)</span>,</span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'fit_hyperbola'</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">a_column_name</span>, <span class="st">'_residuals'</span><span class="op">)</span>, <span class="st">'micromol m^(-2) s^(-1)'</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Get the replicate identifier columns</span></span>
<span>    <span class="va">replicate_identifiers</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/identifier_columns.html">identifier_columns</a></span><span class="op">(</span><span class="va">replicate_exdf</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Attach the residual stats to the identifiers</span></span>
<span>    <span class="va">replicate_identifiers</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span></span>
<span>        <span class="va">replicate_identifiers</span>,</span>
<span>        <span class="fu"><a href="../reference/residual_stats.html">residual_stats</a></span><span class="op">(</span></span>
<span>            <span class="va">replicate_exdf</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">a_column_name</span>, <span class="st">'_residuals'</span><span class="op">)</span><span class="op">]</span>,</span>
<span>            <span class="va">replicate_exdf</span><span class="op">$</span><span class="va">units</span><span class="op">[[</span><span class="va">a_column_name</span><span class="op">]</span><span class="op">]</span>,</span>
<span>            <span class="fl">3</span></span>
<span>        <span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Add the values of the fitted parameters</span></span>
<span>    <span class="va">replicate_identifiers</span><span class="op">[</span>, <span class="st">'A_max'</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">A_max</span></span>
<span>    <span class="va">replicate_identifiers</span><span class="op">[</span>, <span class="st">'A_max_err'</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">A_max_err</span></span>
<span>    <span class="va">replicate_identifiers</span><span class="op">[</span>, <span class="st">'Ci_half'</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">Ci_half</span></span>
<span>    <span class="va">replicate_identifiers</span><span class="op">[</span>, <span class="st">'Ci_half_err'</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">Ci_half_err</span></span>
<span>    <span class="va">replicate_identifiers</span><span class="op">[</span>, <span class="st">'Rd'</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">Rd</span></span>
<span>    <span class="va">replicate_identifiers</span><span class="op">[</span>, <span class="st">'Rd_err'</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">Rd_err</span></span>
<span></span>
<span>    <span class="co"># Document the columns that were added</span></span>
<span>    <span class="va">replicate_identifiers</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/document_variables.html">document_variables</a></span><span class="op">(</span></span>
<span>        <span class="va">replicate_identifiers</span>,</span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'fit_hyperbola'</span>, <span class="st">'A_max'</span>,       <span class="st">'micromol m^(-2) s^(-1)'</span><span class="op">)</span>,</span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'fit_hyperbola'</span>, <span class="st">'A_max_err'</span>,   <span class="st">'micromol m^(-2) s^(-1)'</span><span class="op">)</span>,</span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'fit_hyperbola'</span>, <span class="st">'Ci_half'</span>,     <span class="st">'micromol mol^(-1)'</span><span class="op">)</span>,</span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'fit_hyperbola'</span>, <span class="st">'Ci_half_err'</span>, <span class="st">'micromol mol^(-1)'</span><span class="op">)</span>,</span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'fit_hyperbola'</span>, <span class="st">'Rd'</span>,          <span class="st">'micromol m^(-2) s^(-1)'</span><span class="op">)</span>,</span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'fit_hyperbola'</span>, <span class="st">'Rd_err'</span>,      <span class="st">'micromol m^(-2) s^(-1)'</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      fits <span class="op">=</span> <span class="va">replicate_exdf</span>,</span>
<span>      parameters <span class="op">=</span> <span class="va">replicate_identifiers</span></span>
<span>    <span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Fit each curve</span></span>
<span><span class="va">c3_aci_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/consolidate.html">consolidate</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/by.html" class="external-link">by</a></span><span class="op">(</span></span>
<span>  <span class="va">licor_data</span>,                       <span class="co"># The `exdf` object containing the curves</span></span>
<span>  <span class="va">licor_data</span><span class="op">[</span>, <span class="st">'curve_identifier'</span><span class="op">]</span>, <span class="co"># A factor used to split `licor_data` into chunks</span></span>
<span>  <span class="va">fit_hyperbola</span>                     <span class="co"># The function to apply to each chunk of `licor_data`</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot each fit</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/lattice/man/xyplot.html" class="external-link">xyplot</a></span><span class="op">(</span></span>
<span>  <span class="va">A</span> <span class="op">+</span> <span class="va">A_fit</span> <span class="op">~</span> <span class="va">Ci</span> <span class="op">|</span> <span class="va">curve_identifier</span>,</span>
<span>  data <span class="op">=</span> <span class="va">c3_aci_results</span><span class="op">$</span><span class="va">fits</span><span class="op">$</span><span class="va">main_data</span>,</span>
<span>  type <span class="op">=</span> <span class="st">'l'</span>,</span>
<span>  auto.key <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>space <span class="op">=</span> <span class="st">'right'</span><span class="op">)</span>,</span>
<span>  grid <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  xlab <span class="op">=</span> <span class="st">'Intercellular CO2 concentration (ppm)'</span>,</span>
<span>  ylab <span class="op">=</span> <span class="st">'Assimilation rate (micromol / m^2 / s)'</span>,</span>
<span>  par.settings <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    superpose.line <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>col <span class="op">=</span> <span class="fu"><a href="../reference/multi_curve_colors.html">multi_curve_colors</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    superpose.symbol <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>col <span class="op">=</span> <span class="fu"><a href="../reference/multi_curve_colors.html">multi_curve_colors</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot the residuals</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/lattice/man/xyplot.html" class="external-link">xyplot</a></span><span class="op">(</span></span>
<span>  <span class="va">A_residuals</span> <span class="op">~</span> <span class="va">Ci</span> <span class="op">|</span> <span class="va">curve_identifier</span>,</span>
<span>  data <span class="op">=</span> <span class="va">c3_aci_results</span><span class="op">$</span><span class="va">fits</span><span class="op">$</span><span class="va">main_data</span>,</span>
<span>  type <span class="op">=</span> <span class="st">'b'</span>,</span>
<span>  pch <span class="op">=</span> <span class="fl">16</span>,</span>
<span>  grid <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  xlab <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">'Intercellular CO2 concentration ('</span>,</span>
<span>    <span class="va">c3_aci_results</span><span class="op">$</span><span class="va">fits</span><span class="op">$</span><span class="va">units</span><span class="op">$</span><span class="va">Ci</span>, <span class="st">')'</span><span class="op">)</span>,</span>
<span>  ylab <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">'Assimilation rate residual (measured - fitted)\n('</span>,</span>
<span>    <span class="va">c3_aci_results</span><span class="op">$</span><span class="va">fits</span><span class="op">$</span><span class="va">units</span><span class="op">$</span><span class="va">A_residuals</span>, <span class="st">')'</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># View the parameter values</span></span>
<span><span class="va">columns_for_viewing</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'instrument'</span>, <span class="st">'species'</span>, <span class="st">'plot'</span>, <span class="st">'A_max'</span>, <span class="st">'Ci_half'</span>, <span class="st">'Rd'</span>, <span class="st">'RMSE'</span><span class="op">)</span></span>
<span></span>
<span><span class="va">c3_aci_parameters</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">c3_aci_results</span><span class="op">$</span><span class="va">parameters</span><span class="op">[</span> , <span class="va">columns_for_viewing</span>, <span class="cn">TRUE</span><span class="op">]</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">c3_aci_parameters</span><span class="op">)</span></span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Edward B. Lochocki.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
